sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/m/MessageToast"],function(e,t,n){"use strict";var s={MAX_FILE_SIZE:50*1024*1024,MAX_FILES_PER_SESSION:5,ALLOWED_EXTENSIONS:[".pdf",".doc",".docx",".txt",".md",".json",".xml",".csv",".xlsx",".xls",".ppt",".pptx"],POLL_INTERVAL:2e3,MAX_POLL_ATTEMPTS:60};var r={pdf:{icon:"&#xe9c6;",class:"pdf"},doc:{icon:"&#xe9ca;",class:"doc"},docx:{icon:"&#xe9ca;",class:"docx"},xls:{icon:"&#xe9c9;",class:"xls"},xlsx:{icon:"&#xe9c9;",class:"xlsx"},ppt:{icon:"&#xe9c5;",class:"ppt"},pptx:{icon:"&#xe9c5;",class:"pptx"},txt:{icon:"&#xe9ce;",class:"txt"},md:{icon:"&#xe9ce;",class:"md"},json:{icon:"&#xe9ce;",class:"json"},xml:{icon:"&#xe9ce;",class:"xml"},csv:{icon:"&#xe9c9;",class:"csv"},default:{icon:"&#xe9c4;",class:"default"}};return e.extend("com.ai.assistant.aichatapp.controller.Main",{onInit:function(){var e=this.getOwnerComponent().getRouter();e.getRoute("chat").attachPatternMatched(this._onRouteMatched,this)},_syncWelcomeBoxAfterRender:function(){var e=this.getView().getModel("chat");var t=e.getProperty("/messages")||[];if(t.length>0){this._renderMessages();this._hideWelcomeBox()}else{this._showWelcomeBox()}},onAfterRendering:function(){this._bindKeyboardShortcut();this._bindFileInputChange();this._renderAttachmentsFromModel();this._syncWelcomeBoxAfterRender()},_bindKeyboardShortcut:function(){if(this._bKeyboardBound){return}var e=this;var t=this.byId("messageInput");if(t&&t.getDomRef()){var n=t.getDomRef();var s=n.querySelector("textarea");if(s){s.addEventListener("keydown",function(t){if(t.key==="Enter"&&!t.shiftKey){t.preventDefault();t.stopPropagation();e.onSendMessage()}},true);this._bKeyboardBound=true}}},_onRouteMatched:function(e){var t=e.getParameter("arguments").aiType;var n=this.getView().getModel("chat");var s=this.getView().getModel("i18n").getResourceBundle();var r=n.getProperty("/currentAiType");if(!n.getProperty("/attachments")){n.setProperty("/attachments",[])}n.setProperty("/currentAiType",t);var i=this._getAiTitleKey(t);var a=s.getText(i);n.setProperty("/currentAiTitle",a);this.byId("chatPageTitle").setText(a);this._updateWelcomeMessage(t);if(r&&r!==t){this._resetCurrentConversation()}this._filterConversationsByAiType(t)},_resetCurrentConversation:function(){var e=this.getView().getModel("chat");e.setProperty("/currentConversationId",null);e.setProperty("/messages",[]);this._setAttachmentsForConversation(null);this._clearMessageContainer();this._showWelcomeBox()},_filterConversationsByAiType:function(e){var t=this.getView().getModel("chat");var n=this.getOwnerComponent()._aAllConversations||[];var s=n.filter(function(t){return t.aiType===e});t.setProperty("/conversations",s)},_updateWelcomeMessage:function(e){var t=this.getView().getModel("i18n").getResourceBundle();var n=this.byId("welcomeBox");if(!n){return}var s="welcomeTitle_"+e;var r="welcomeMessage_"+e;var i=t.getText(s);var a=t.getText(r);if(i===s){i=t.getText("welcomeTitle")}if(a===r){a=t.getText("welcomeMessage")}var o=n.getItems();o.forEach(function(e){if(e.isA("sap.m.Title")){e.setText(i)}else if(e.isA("sap.m.Text")){e.setText(a)}})},_getAiTitleKey:function(e){var t={"abap-clean-core":"abapCleanCoreTitle",cpi:"cpiAiTitle","func-doc":"funcDocAiTitle","tech-doc":"techDocAiTitle","code-review":"codeReviewTitle","unit-test":"unitTestTitle"};return t[e]||"appTitle"},onNavBack:function(){var e=this.getOwnerComponent().getRouter();e.navTo("home")},onToggleSidebar:function(){var e=this.byId("flexibleColumnLayout");var t=e.getLayout();if(t==="OneColumn"||t==="MidColumnFullScreen"){e.setLayout("TwoColumnsMidExpanded")}else{e.setLayout("MidColumnFullScreen")}},onNewConversation:function(){var e=this.getView().getModel("chat");var t=this.getView().getModel("i18n").getResourceBundle();var s=e.getProperty("/currentAiType");var r={id:this._generateUUID(),title:t.getText("newConversation"),messages:[],lastUpdate:this._formatDate(new Date),sessionId:null,sessionInfo:null,attachments:[],aiType:s};var i=this.getOwnerComponent()._aAllConversations||[];i.unshift(r);this.getOwnerComponent()._aAllConversations=i;var a=e.getProperty("/conversations")||[];a.unshift(r);e.setProperty("/conversations",a);e.setProperty("/currentConversationId",r.id);e.setProperty("/messages",[]);this._setAttachmentsForConversation(r);this._clearMessageContainer();this._showWelcomeBox();this.getOwnerComponent().saveConversationsToStorage();n.show(t.getText("newConversationCreated"))},onConversationSelect:function(e){var t;var n=e.getSource();if(e.getParameter("listItem")){t=e.getParameter("listItem").getBindingContext("chat")}else{t=n.getBindingContext("chat")}if(t){var s=t.getObject();var r=this.getView().getModel("chat");var i=r.getProperty("/conversations")||[];var a=i.find(function(e){return e.id===s.id});if(a){r.setProperty("/currentConversationId",a.id);var o=JSON.parse(JSON.stringify(a.messages||[]));r.setProperty("/messages",o);this._setAttachmentsForConversation(a);this._renderMessages();if(o.length>0){this._hideWelcomeBox()}else{this._showWelcomeBox()}this._scrollToBottom()}}},onEditConversationTitle:function(e){var t=this;var s=e.getSource();var r=s.getBindingContext("chat");if(this._bEditDialogOpen){return}if(r){var i=r.getObject();var a=r.getPath();this._bEditDialogOpen=true;var o=this.getView().getModel("i18n").getResourceBundle();sap.ui.require(["sap/m/Dialog","sap/m/Input","sap/m/Button"],function(e,s,r){var c=new s({value:i.title,width:"100%",placeholder:o.getText("editTitle")});var l=new e({title:o.getText("editTitle"),type:"Message",content:[c],beginButton:new r({text:o.getText("ok"),type:"Emphasized",press:function(){var e=c.getValue();if(e.trim()){var s=t.getView().getModel("chat");s.setProperty(a+"/title",e.trim());t.getOwnerComponent().saveConversationsToStorage();n.show(o.getText("titleUpdated"))}l.close()}}),endButton:new r({text:o.getText("cancel"),press:function(){l.close()}}),afterClose:function(){l.destroy();t._bEditDialogOpen=false}});l.open()})}},onDeleteConversation:function(e){var s=this;var r=e.getSource();var i=r.getBindingContext("chat");var a=this.getView().getModel("i18n").getResourceBundle();if(i){var o=i.getObject();t.confirm(a.getText("confirmDelete"),{title:a.getText("confirmDeleteTitle"),onClose:function(e){if(e===t.Action.OK){var r=s.getView().getModel("chat");var i=r.getProperty("/conversations");var c=r.getProperty("/currentConversationId");i=i.filter(function(e){return e.id!==o.id});r.setProperty("/conversations",i);var l=s.getOwnerComponent()._aAllConversations||[];l=l.filter(function(e){return e.id!==o.id});s.getOwnerComponent()._aAllConversations=l;if(c===o.id){r.setProperty("/currentConversationId",null);r.setProperty("/messages",[]);s._setAttachmentsForConversation(null);s._clearMessageContainer();s._showWelcomeBox()}s.getOwnerComponent().saveConversationsToStorage();n.show(a.getText("conversationDeleted"))}}})}},onSendMessage:function(){var e=this.getView().getModel("chat");var t=this.byId("messageInput");var n=t?t.getValue():e.getProperty("/inputValue");var s=e.getProperty("/isLoading");if(!n||!n.trim()||s){return}e.setProperty("/inputValue",n);var r=e.getProperty("/currentConversationId");if(!r){this.onNewConversation();r=e.getProperty("/currentConversationId")}var i={id:this._generateUUID(),role:"user",content:n.trim(),timestamp:(new Date).toISOString()};var a=e.getProperty("/messages")||[];a.push(i);e.setProperty("/messages",a);e.setProperty("/inputValue","");if(t){t.setValue("")}this._hideWelcomeBox();this._renderUserMessage(i);e.setProperty("/isLoading",true);var o={id:this._generateUUID(),role:"assistant",content:"",timestamp:(new Date).toISOString()};a.push(o);e.setProperty("/messages",a);this._renderAIMessageContainer(o.id);this._scrollToBottom();this._callAIStream(n.trim(),o.id)},_SESSION_CONFIG:{MAX_ROUNDS:50,EXPIRE_HOURS:1,FALLBACK_ROUNDS:10},_callAIStream:function(e,t){var s=this;var r=this.getView().getModel("chat");var i=this.getView().getModel("i18n").getResourceBundle();var a=r.getProperty("/currentConversationId");var o=r.getProperty("/conversations");var c=o.find(function(e){return e.id===a});var l=c?c.sessionId:null;var d=c?c.sessionInfo:null;var u=r.getProperty("/messages")||[];var g=r.getProperty("/currentAiType");var f=this._buildRequestBody(e,l,d,u,g);fetch("/api/chat/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)}).then(function(e){if(!e.ok){throw new Error(i.getText("networkError"))}if(!e.body){throw new Error(i.getText("streamNotSupported"))}var a=e.body.getReader();var l=new TextDecoder;var d="";var u="";function g(e){if(!e||!e.startsWith("data:")){return}var i=e.slice(5).trim();if(!i||i==="[DONE]"){return}try{var a=JSON.parse(i);if(a.error){n.show(a.error);return}if(a.text){d+=a.text;s._updateAIMessageContent(t,d);s._scrollToBottom()}if(a.sessionId&&c&&!c._sessionIdSaved){var l=o.findIndex(function(e){return e.id===c.id});if(l>=0){o[l].sessionId=a.sessionId;c._sessionIdSaved=true;r.setProperty("/conversations",o)}}}catch(e){}}function f(e){u+=e;var t=u.split(/\r?\n/);u=t.pop();t.forEach(g)}function h(){return a.read().then(function(e){if(e.done){if(u.trim()){g(u)}s._finalizeAIMessage(t,d);r.setProperty("/isLoading",false);return}var n=l.decode(e.value,{stream:true});f(n);return h()}).catch(function(e){console.error("流读取错误:",e);if(d){s._finalizeAIMessage(t,d)}r.setProperty("/isLoading",false);n.show(i.getText("connectionInterrupted"))})}return h()}).catch(function(e){console.error("AI调用错误:",e);n.show(i.getText("aiServiceUnavailable"));r.setProperty("/isLoading",false);var s=r.getProperty("/messages");s=s.filter(function(e){return e.id!==t});r.setProperty("/messages",s);var a=document.getElementById("ai-msg-"+t);if(a){a.remove()}})},_renderUserMessage:function(e){var t=this;var n=this.byId("messageList");var s=n.getDomRef();if(!s){setTimeout(function(){t._renderUserMessage(e)},100);return}var r='<div class="messageItem userMessage" id="user-msg-'+e.id+'">'+'<div class="avatarContainer">'+'<span class="sapUiIcon userAvatar" style="font-family: SAP-icons">&#xe036;</span>'+"</div>"+'<div class="messageContent">'+'<div class="messageText">'+this._escapeHtml(e.content)+"</div>"+"</div>"+"</div>";s.insertAdjacentHTML("beforeend",r)},_renderAIMessageContainer:function(e){var t=this;var n=this.byId("messageList");var s=n.getDomRef();if(!s){setTimeout(function(){t._renderAIMessageContainer(e)},100);return}var r='<div class="messageItem aiMessage" id="ai-msg-'+e+'">'+'<div class="avatarContainer">'+'<span class="sapUiIcon aiAvatar" style="font-family: SAP-icons">&#xe1c3;</span>'+"</div>"+'<div class="messageContent">'+'<div class="messageText" id="ai-text-'+e+'">'+'<div class="typingIndicator"><span></span><span></span><span></span></div>'+"</div>"+"</div>"+"</div>";s.insertAdjacentHTML("beforeend",r)},_updateAIMessageContent:function(e,t){var n=this.getView().getModel("chat");var s=n.getProperty("/messages")||[];var r=s.find(function(t){return t.id===e});if(r){r.content=t}var i=document.getElementById("ai-text-"+e);if(i){var a=this._renderMarkdown(t);i.innerHTML=a;this._highlightCode(i);this._addCopyButtons(i)}},_finalizeAIMessage:function(e,t){var n=this.getView().getModel("chat");var s=n.getProperty("/messages");var r=n.getProperty("/currentConversationId");var i=s.find(function(t){return t.id===e});if(i){i.content=t}var a=n.getProperty("/conversations");var o=a.findIndex(function(e){return e.id===r});if(o>=0){a[o].messages=JSON.parse(JSON.stringify(s));a[o].lastUpdate=this._formatDate(new Date);if(a[o].sessionId){if(!a[o].sessionInfo){a[o].sessionInfo={createdAt:(new Date).toISOString(),roundCount:1}}else{a[o].sessionInfo.roundCount++}console.log("[AI] 当前轮次: "+a[o].sessionInfo.roundCount)}delete a[o]._sessionIdSaved;var c=this.getView().getModel("i18n").getResourceBundle();var l=c.getText("newConversation");if(s.length<=2&&a[o].title===l){var d=s[0]?s[0].content:"";a[o].title=d.substring(0,20)+(d.length>20?"...":"")}}n.setProperty("/conversations",a);n.setProperty("/messages",s);this._syncToAllConversations(a);this.getOwnerComponent().saveConversationsToStorage()},_syncToAllConversations:function(e){var t=this.getOwnerComponent()._aAllConversations||[];e.forEach(function(e){var n=t.findIndex(function(t){return t.id===e.id});if(n>=0){t[n]=e}});this.getOwnerComponent()._aAllConversations=t},_renderMarkdown:function(e){if(typeof marked!=="undefined"){marked.setOptions({breaks:true,gfm:true});var t=this._escapeHtml(e);return marked.parse(t)}return this._escapeHtml(e)},_highlightCode:function(e){if(typeof hljs!=="undefined"){var t=e.querySelectorAll("pre code");t.forEach(function(e){hljs.highlightElement(e)})}},_copyTextToClipboard:function(e){if(navigator.clipboard&&navigator.clipboard.writeText){return navigator.clipboard.writeText(e)}return new Promise(function(t,n){var s=document.createElement("textarea");s.value=e;s.setAttribute("readonly","");s.style.position="absolute";s.style.left="-9999px";document.body.appendChild(s);s.select();try{var r=document.execCommand("copy");if(r){t()}else{n(new Error("copy failed"))}}catch(e){n(e)}finally{document.body.removeChild(s)}})},_addCopyButtons:function(e){var t=this;var s=e.querySelectorAll("pre");var r=this.getView().getModel("i18n").getResourceBundle();var i=r.getText("copy");var a=r.getText("copied");var o=r.getText("copyFailed");s.forEach(function(e){if(e.querySelector(".copyButton")){return}var s=document.createElement("button");s.className="copyButton";s.innerHTML='<span class="sapUiIcon" style="font-family: SAP-icons">&#xe0ec;</span> '+i;s.onclick=function(){var r=e.querySelector("code")?e.querySelector("code").textContent:e.textContent;t._copyTextToClipboard(r).then(function(){s.innerHTML='<span class="sapUiIcon" style="font-family: SAP-icons">&#xe05b;</span> '+a;setTimeout(function(){s.innerHTML='<span class="sapUiIcon" style="font-family: SAP-icons">&#xe0ec;</span> '+i},2e3)}).catch(function(){n.show(o)})};var r=document.createElement("div");r.className="codeBlockWrapper";e.parentNode.insertBefore(r,e);r.appendChild(e);r.appendChild(s)})},_renderMessages:function(){var e=this;var t=this.getView().getModel("chat");var n=t.getProperty("/messages")||[];this._clearMessageContainer();n.forEach(function(t){if(t.role==="user"){e._renderUserMessage(t)}else if(t.role==="assistant"){e._renderAIMessageContainer(t.id);if(t.content){e._updateAIMessageContent(t.id,t.content)}}})},_clearMessageContainer:function(){var e=this.byId("messageList");var t=e.getDomRef();if(t){t.innerHTML=""}},_scrollToBottom:function(){var e=this.byId("messageScrollContainer");if(e){setTimeout(function(){var t=e.getDomRef();if(t){t.scrollTop=t.scrollHeight}},100)}},_buildRequestBody:function(e,t,n,s,r){var i=this._shouldUseSessionId(t,n);var a=this._getReadySessionFileIds();if(a.length>0){console.log("[AI] 附带会话文件: "+a.join(", "))}if(i){console.log("[AI] 使用 session_id 模式");return{message:e,sessionId:t,sessionInfo:n,aiType:r,sessionFileIds:a}}else if(s&&s.length>2){console.log("[AI] 使用 messages 模式（降级）");var o=this._buildMessagesArray(s);return{message:e,messages:o,sessionInfo:n,aiType:r,sessionFileIds:a}}else{console.log("[AI] 新对话模式");return{message:e,aiType:r,sessionFileIds:a}}},_shouldUseSessionId:function(e,t){if(!e){return false}if(!t){return true}if(t.roundCount>=this._SESSION_CONFIG.MAX_ROUNDS){console.log("[AI] session_id 已达轮次上限，切换到 messages 模式");return false}if(t.createdAt){var n=new Date(t.createdAt).getTime();var s=Date.now();var r=this._SESSION_CONFIG.EXPIRE_HOURS*60*60*1e3;if(s-n>r){console.log("[AI] session_id 已过期，切换到 messages 模式");return false}}return true},_buildMessagesArray:function(e){var t=e.slice(0,-2);var n=this._SESSION_CONFIG.FALLBACK_ROUNDS;var s=n*2;if(t.length>s){t=t.slice(-s)}return t.filter(function(e){return e.content}).map(function(e){var t=e.content;if(e.role==="assistant"&&t.length>1e3){t=t.substring(0,1e3)+"..."}return{role:e.role,content:t}})},_buildContextPrompt:function(e,t){if(e.length<=2){return t}var n=e.slice(0,-2);var s="以下是我们之前的对话历史：\n\n";n.forEach(function(e){if(e.role==="user"){s+="用户: "+e.content+"\n\n"}else if(e.role==="assistant"&&e.content){var t=e.content.length>500?e.content.substring(0,500)+"...":e.content;s+="助手: "+t+"\n\n"}});s+="---\n\n现在用户的新问题是：\n"+t;s+="\n\n请基于以上对话历史来回答用户的问题。";return s},_generateUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0;var n=e==="x"?t:t&3|8;return n.toString(16)})},_formatDate:function(e){var t=e.getFullYear();var n=String(e.getMonth()+1).padStart(2,"0");var s=String(e.getDate()).padStart(2,"0");var r=String(e.getHours()).padStart(2,"0");var i=String(e.getMinutes()).padStart(2,"0");return t+"-"+n+"-"+s+" "+r+":"+i},_escapeHtml:function(e){var t=document.createElement("div");t.textContent=e;return t.innerHTML},_hideWelcomeBox:function(){var e=this.byId("welcomeBox");if(e){e.setVisible(false)}},_showWelcomeBox:function(){var e=this.byId("welcomeBox");if(e){e.setVisible(true)}},_setAttachmentsForConversation:function(e){var t=this.getView().getModel("chat");if(e&&!Array.isArray(e.attachments)){e.attachments=[]}var n=e?e.attachments:[];t.setProperty("/attachments",n);this._renderAttachmentsFromModel()},_renderAttachmentsFromModel:function(){var e=this.getView().getModel("chat");var t=e.getProperty("/attachments")||[];this._clearAttachmentDom();t.forEach(function(e){this._renderAttachmentCard(e)}.bind(this));this._updateAttachmentAreaVisibility()},_clearAttachmentDom:function(){var e=this.byId("attachmentList");if(e){var t=e.getDomRef();if(t){t.innerHTML=""}}},_updateCurrentConversationAttachments:function(e){var t=this.getView().getModel("chat");var n=t.getProperty("/currentConversationId");if(!n){return}var s=t.getProperty("/conversations")||[];var r=s.findIndex(function(e){return e.id===n});if(r>=0){s[r].attachments=e;t.setProperty("/conversations",s);this._syncToAllConversations(s)}},_bindFileInputChange:function(){var e=this;setTimeout(function(){var t=document.getElementById("hiddenFileInput");if(t&&!t._boundChange){t.addEventListener("change",function(t){e._handleFileSelect(t)});t._boundChange=true}},500)},onUploadFile:function(){var e=this.getView().getModel("chat");var t=e.getProperty("/attachments")||[];var r=this.getView().getModel("i18n").getResourceBundle();if(t.length>=s.MAX_FILES_PER_SESSION){n.show(r.getText("maxFilesReached")||"最多只能上传 "+s.MAX_FILES_PER_SESSION+" 个文件");return}var i=document.getElementById("hiddenFileInput");if(i){i.value="";i.click()}},_handleFileSelect:function(e){var n=this;var r=e.target.files[0];var i=this.getView().getModel("i18n").getResourceBundle();if(!r){return}if(r.size>s.MAX_FILE_SIZE){t.error((i.getText("fileTooLarge")||"文件过大")+"，最大支持 "+this._formatFileSize(s.MAX_FILE_SIZE));return}var a="."+r.name.split(".").pop().toLowerCase();if(!s.ALLOWED_EXTENSIONS.includes(a)){t.error((i.getText("unsupportedFileType")||"不支持的文件类型")+": "+a);return}var o={id:this._generateUUID(),file:r,fileName:r.name,fileSize:r.size,fileExt:a.substring(1),status:"uploading",progress:0,fileId:null,message:i.getText("uploading")||"上传中..."};var c=this.getView().getModel("chat");var l=c.getProperty("/attachments")||[];l.push(o);c.setProperty("/attachments",l);this._updateCurrentConversationAttachments(l);this._renderAttachmentCard(o);this._updateAttachmentAreaVisibility();this._uploadFile(o)},_uploadFile:function(e){var t=this;var s=this.getView().getModel("i18n").getResourceBundle();var r=new FormData;r.append("file",e.file);var i=0;var a=setInterval(function(){if(i<90){i+=10;t._updateAttachmentCard(e.id,{progress:i,status:"uploading"})}},200);fetch("/api/files/session",{method:"POST",body:r}).then(function(e){clearInterval(a);if(!e.ok){return e.json().then(function(e){throw new Error(e.error||"上传失败")})}return e.json()}).then(function(n){t._updateAttachmentCard(e.id,{fileId:n.fileId,status:"processing",progress:100,message:s.getText("parsing")||"解析中..."});t._updateAttachmentInModel(e.id,{fileId:n.fileId,status:"processing"});t._pollFileStatus(e.id,n.fileId,0)}).catch(function(s){clearInterval(a);console.error("[FileUpload] 上传错误:",s);t._updateAttachmentCard(e.id,{status:"error",progress:0,message:s.message||"上传失败"});t._updateAttachmentInModel(e.id,{status:"error",message:s.message});n.show(s.message||"文件上传失败")})},_pollFileStatus:function(e,t,r){var i=this;var a=this.getView().getModel("i18n").getResourceBundle();if(r>=s.MAX_POLL_ATTEMPTS){i._updateAttachmentCard(e,{status:"error",message:a.getText("parseTimeout")||"解析超时"});i._updateAttachmentInModel(e,{status:"error",message:"解析超时"});return}fetch("/api/files/session/"+t+"/status").then(function(e){if(!e.ok){throw new Error("查询状态失败")}return e.json()}).then(function(o){if(o.status==="ready"){i._updateAttachmentCard(e,{status:"ready",progress:100,message:a.getText("ready")||"已就绪"});i._updateAttachmentInModel(e,{status:"ready"});n.show(o.fileName+" "+(a.getText("parseComplete")||"解析完成"))}else if(o.status==="error"){i._updateAttachmentCard(e,{status:"error",message:o.message||"解析失败"});i._updateAttachmentInModel(e,{status:"error",message:o.message})}else{i._updateAttachmentCard(e,{status:"processing",message:o.message||"解析中..."});setTimeout(function(){i._pollFileStatus(e,t,r+1)},s.POLL_INTERVAL)}}).catch(function(n){console.error("[FileUpload] 轮询状态错误:",n);setTimeout(function(){i._pollFileStatus(e,t,r+1)},s.POLL_INTERVAL)})},_renderAttachmentCard:function(e){var t=this;var n=this.byId("attachmentList");if(!n){return}var s=n.getDomRef();if(!s){setTimeout(function(){t._renderAttachmentCard(e)},100);return}var r=this._getFileTypeIcon(e.fileExt);var i=e.status==="ready"?"complete":"";var a=this._escapeHtml(e.fileName||"");var o=this._escapeHtml(e.message||"");var c=e.status==="processing"?"indeterminate":"";var l='<div class="fileCard" id="file-card-'+e.id+'">'+'<div class="fileIconContainer '+r.class+'">'+'<span class="sapUiIcon fileIcon" style="font-family: SAP-icons">'+r.icon+"</span>"+"</div>"+'<div class="fileInfo">'+'<span class="fileName" title="'+a+'">'+a+"</span>"+'<span class="fileStatus '+e.status+'" id="file-status-'+e.id+'">'+o+"</span>"+'<div class="progressBarContainer '+c+'" id="file-progress-container-'+e.id+'">'+'<div class="progressBar '+i+'" id="file-progress-'+e.id+'" style="width: '+e.progress+'%"></div>'+"</div>"+"</div>"+'<button class="fileDeleteBtn" id="file-delete-'+e.id+'" title="删除">'+'<span class="sapUiIcon deleteIcon" style="font-family: SAP-icons">&#xe03e;</span>'+"</button>"+"</div>";s.insertAdjacentHTML("beforeend",l);var d=document.getElementById("file-delete-"+e.id);if(d){d.addEventListener("click",function(){t._removeAttachment(e.id)})}},_updateAttachmentCard:function(e,t){var n=document.getElementById("file-status-"+e);var s=document.getElementById("file-progress-"+e);var r=document.getElementById("file-progress-container-"+e);var i=document.getElementById("file-card-"+e);if(n&&t.message!==undefined){n.textContent=t.message;n.className="fileStatus "+(t.status||"")}if(s&&t.progress!==undefined){s.style.width=t.progress+"%";if(t.status==="ready"){s.classList.add("complete")}}if(r&&t.status){if(t.status==="processing"){r.classList.add("indeterminate")}else{r.classList.remove("indeterminate")}}if(i&&t.status==="ready"){i.classList.add("ready")}},_updateAttachmentInModel:function(e,t){var n=this.getView().getModel("chat");var s=n.getProperty("/attachments")||[];var r=s.findIndex(function(t){return t.id===e});if(r>=0){Object.assign(s[r],t);n.setProperty("/attachments",s);this._updateCurrentConversationAttachments(s)}},_removeAttachment:function(e){var t=this.getView().getModel("chat");var n=t.getProperty("/attachments")||[];n=n.filter(function(t){return t.id!==e});t.setProperty("/attachments",n);this._updateCurrentConversationAttachments(n);var s=document.getElementById("file-card-"+e);if(s){s.remove()}this._updateAttachmentAreaVisibility()},_updateAttachmentAreaVisibility:function(){var e=this.getView().getModel("chat");var t=e.getProperty("/attachments")||[];var n=this.byId("attachmentPreviewArea");if(n){n.setVisible(t.length>0)}},_getFileTypeIcon:function(e){var t=(e||"").toLowerCase();return r[t]||r["default"]},_formatFileSize:function(e){if(e<1024){return e+" B"}else if(e<1024*1024){return(e/1024).toFixed(1)+" KB"}else{return(e/(1024*1024)).toFixed(1)+" MB"}},_getReadySessionFileIds:function(){var e=this.getView().getModel("chat");var t=e.getProperty("/attachments")||[];return t.filter(function(e){return e.status==="ready"&&e.fileId&&e.fileId.startsWith("file_session_")}).map(function(e){return e.fileId})},_clearAttachments:function(){var e=this.getView().getModel("chat");e.setProperty("/attachments",[]);this._updateCurrentConversationAttachments([]);this._clearAttachmentDom();this._updateAttachmentAreaVisibility()}})});
//# sourceMappingURL=Main.controller.js.map