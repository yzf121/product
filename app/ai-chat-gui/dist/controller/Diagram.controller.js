sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/core/HTML"],function(e,t,r,i,a){"use strict";return e.extend("com.ai.assistant.aichatapp.controller.Diagram",{_DIAGRAM_AI_TYPE:"diagram",_ZOOM_STEP:.15,_MIN_ZOOM:.2,_MAX_ZOOM:3,_renderCount:0,onInit:function(){var e=new i({inputValue:"",mermaidCode:"",isLoading:false,hasMermaid:false,showFixButton:false,errorMessage:"",viewMode:"preview",zoomLevel:1,lastAiResponse:"",sessionId:null});this.getView().setModel(e,"diagram");this._initMermaid()},onAfterRendering:function(){this._initPreviewArea()},_initMermaid:function(){var e=this;if(typeof mermaid!=="undefined"){this._configureMermaid();return}var t=document.createElement("script");t.src=sap.ui.require.toUrl("com/ai/assistant/aichatapp/lib/mermaid.min.js");t.onload=function(){e._configureMermaid();console.log("[Diagram] Mermaid 库加载完成")};t.onerror=function(){console.error("[Diagram] Mermaid 库加载失败");r.show(e._getI18nText("mermaidLoadFailed"))};document.head.appendChild(t)},_configureMermaid:function(){if(typeof mermaid!=="undefined"){mermaid.initialize({startOnLoad:false,theme:"default",securityLevel:"loose",fontFamily:"Microsoft YaHei, SimHei, Arial, sans-serif",flowchart:{useMaxWidth:false,htmlLabels:true,curve:"basis",padding:20},sequence:{useMaxWidth:false},gantt:{useMaxWidth:false}})}},_initPreviewArea:function(){if(this._bPreviewInitializing){return}var e=this.byId("previewContainer");if(!e){console.warn("[Diagram] previewContainer 未找到");return}var t=e.getDomRef();if(!t){var r=this;this._bPreviewInitializing=true;setTimeout(function(){r._bPreviewInitializing=false;r._initPreviewArea()},100);return}this._createPreviewHTML(t);this._initInteractions();console.log("[Diagram] 预览区域初始化完成")},_createPreviewHTML:function(e){e.innerHTML="";var t=document.createElement("div");t.id=this.getView().getId()+"--previewArea";t.className="mermaidPreviewArea";var r=document.createElement("div");r.className="mermaidContentWrapper";r.id=this.getView().getId()+"--mermaidContent";r.innerHTML='<div class="diagramPlaceholder">'+'<span class="sapUiIcon" style="font-family:SAP-icons;font-size:4rem;color:#bbb;">&#xe145;</span>'+"<p>输入描述并点击生成按钮来创建流程图</p>"+"</div>";t.appendChild(r);e.appendChild(t);this._oPreviewArea=t;this._oContentWrapper=r},_initInteractions:function(){var e=this;var t=this._oPreviewArea;if(!t)return;var r=false;var i,a,n,o;t.addEventListener("mousedown",function(e){if(e.target.closest("svg")||e.target.closest(".mermaidContentWrapper")){r=true;t.style.cursor="grabbing";i=e.pageX-t.offsetLeft;a=e.pageY-t.offsetTop;n=t.scrollLeft;o=t.scrollTop;e.preventDefault()}});t.addEventListener("mousemove",function(e){if(!r)return;e.preventDefault();var s=e.pageX-t.offsetLeft;var d=e.pageY-t.offsetTop;var l=(s-i)*1.5;var c=(d-a)*1.5;t.scrollLeft=n-l;t.scrollTop=o-c});document.addEventListener("mouseup",function(){if(r){r=false;if(t){t.style.cursor="grab"}}});t.addEventListener("wheel",function(t){if(t.ctrlKey){t.preventDefault();if(t.deltaY<0){e.onZoomIn()}else{e.onZoomOut()}}},{passive:false})},onNavBack:function(){var e=this.getOwnerComponent().getRouter();e.navTo("home")},onGenerateDiagram:function(){var e=this;var t=this.getView().getModel("diagram");var i=t.getProperty("/inputValue");if(!i||!i.trim()){r.show(this._getI18nText("pleaseEnterDescription"));return}if(t.getProperty("/isLoading")){return}if(!this._oContentWrapper){this._initPreviewArea();setTimeout(function(){e.onGenerateDiagram()},200);return}var a=i.trim()+"\n\n"+"【重要要求】请严格按照以下格式输出：\n"+"1. 必须使用 ```mermaid 开头和 ``` 结尾包裹代码\n"+"2. 使用 flowchart TD 或 graph TD 语法\n"+"3. 节点ID使用英文字母，显示文本用中文\n"+"4. 示例格式：\n"+"```mermaid\n"+"flowchart TD\n"+"    A[开始] --\x3e B[处理]\n"+"    B --\x3e C[结束]\n"+"```";this._callDiagramAI(a,false)},onRegenerateDiagram:function(){this.onGenerateDiagram()},_callDiagramAI:function(e,t){var i=this;var a=this.getView().getModel("diagram");a.setProperty("/isLoading",true);a.setProperty("/showFixButton",false);a.setProperty("/errorMessage","");var n=a.getProperty("/sessionId");var o={message:e,aiType:this._DIAGRAM_AI_TYPE};if(n){o.sessionId=n}fetch("/api/chat/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then(function(e){if(!e.ok){throw new Error(i._getI18nText("networkError"))}if(!e.body){throw new Error(i._getI18nText("streamNotSupported"))}var n=e.body.getReader();var o=new TextDecoder;var s="";var d="";function l(e){if(!e||!e.startsWith("data:")){return}var t=e.slice(5).trim();if(!t||t==="[DONE]"){return}try{var i=JSON.parse(t);if(i.error){r.show(i.error);return}if(i.text){s+=i.text}if(i.sessionId){a.setProperty("/sessionId",i.sessionId)}}catch(e){}}function c(e){d+=e;var t=d.split(/\r?\n/);d=t.pop();t.forEach(l)}function m(){return n.read().then(function(e){if(e.done){if(d.trim()){l(d)}i._processAIResponse(s,t);a.setProperty("/isLoading",false);return}var r=o.decode(e.value,{stream:true});c(r);return m()})}return m()}).catch(function(e){console.error("[Diagram] AI 调用错误:",e);r.show(i._getI18nText("aiServiceUnavailable"));a.setProperty("/isLoading",false)})},_processAIResponse:function(e,t){var i=this.getView().getModel("diagram");i.setProperty("/lastAiResponse",e);var a=this._extractMermaidCode(e);if(a){a=this._cleanMermaidCode(a);i.setProperty("/mermaidCode",a);i.setProperty("/hasMermaid",true);i.setProperty("/showFixButton",false);this._renderMermaid(a);r.show(this._getI18nText("diagramGenerated"))}else{i.setProperty("/hasMermaid",false);i.setProperty("/showFixButton",true);i.setProperty("/errorMessage",this._getI18nText("outputFormatError"));if(t){r.show(this._getI18nText("fixFailed"))}}},_extractMermaidCode:function(e){if(!e)return null;var t=/```mermaid\s*([\s\S]*?)```/i;var r=e.match(t);if(r&&r[1]){return r[1].trim()}var i=/```\s*(graph|flowchart|sequenceDiagram|classDiagram|stateDiagram|erDiagram|journey|gantt|pie|gitGraph|subgraph)([\s\S]*?)```/i;r=e.match(i);if(r){return(r[1]+r[2]).trim()}var a=/^(graph|flowchart)\s+(TB|TD|BT|RL|LR)[\s\S]+/im;r=e.match(a);if(r){return r[0].trim()}return null},_cleanMermaidCode:function(e){if(!e)return e;var t=e;t=t.replace(/^\uFEFF/,"");t=t.replace(/\r\n/g,"\n").replace(/\r/g,"\n");t=t.replace(/\n{3,}/g,"\n\n");if(/^flowchart\s*$/im.test(t)){t=t.replace(/^flowchart\s*$/im,"flowchart TD")}if(/^graph\s*$/im.test(t)){t=t.replace(/^graph\s*$/im,"graph TD")}t=t.replace(/：/g,":").replace(/；/g,";");t=t.replace(/--\s*>/g,"--\x3e").replace(/-\s+->/g,"--\x3e");t=t.split("\n").map(function(e){return e.trimEnd()}).join("\n");if(!t.endsWith("\n")){t+="\n"}return t.trim()},onFixOutputFormat:function(){var e=this.getView().getModel("diagram");var t=e.getProperty("/lastAiResponse");var r=e.getProperty("/inputValue");var i="你之前的回复格式不正确，我无法提取 Mermaid 代码。请重新生成。\n\n"+"【严格要求】\n"+"1. 必须使用 ```mermaid 开头\n"+"2. 必须使用 ``` 结尾\n"+"3. 使用 flowchart TD 语法\n"+"4. 节点ID用英文，显示文本用中文放在方括号内\n\n"+"原始需求："+r+"\n\n"+"正确格式示例：\n"+"```mermaid\n"+"flowchart TD\n"+"    A[开始] --\x3e B[处理]\n"+"    B --\x3e C{判断}\n"+"    C --\x3e|是| D[结束]\n"+"    C --\x3e|否| B\n"+"```\n\n"+"请按此格式重新生成流程图。";this._callDiagramAI(i,true)},onMermaidCodeChange:function(){var e=this.getView().getModel("diagram");var t=e.getProperty("/mermaidCode");e.setProperty("/hasMermaid",t&&t.trim()!=="")},onRenderMermaid:function(){var e=this.getView().getModel("diagram");var t=e.getProperty("/mermaidCode");if(!t||!t.trim()){r.show(this._getI18nText("noMermaidCode"));return}var i=this._cleanMermaidCode(t);e.setProperty("/mermaidCode",i);this._renderMermaid(i)},_renderMermaid:function(e){var t=this;var i=this.getView().getModel("diagram");if(!this._oContentWrapper){this._initPreviewArea();setTimeout(function(){t._renderMermaid(e)},200);return}if(typeof mermaid==="undefined"){r.show(this._getI18nText("mermaidNotLoaded"));return}i.setProperty("/showFixButton",false);this._renderCount++;var a="mermaid-diagram-"+this._renderCount+"-"+Date.now();this._oContentWrapper.innerHTML="";var n=document.createElement("div");n.className="mermaidRenderContainer";n.id=a+"-container";this._oContentWrapper.appendChild(n);try{mermaid.render(a,e).then(function(e){n.innerHTML=e.svg;var a=n.querySelector("svg");if(a){a.style.maxWidth="none";a.style.height="auto";a.style.minWidth="400px";a.style.display="block";t._oRenderedSvg=a;t._nOriginalWidth=null;t._nOriginalHeight=null}i.setProperty("/zoomLevel",1);if(t._oPreviewArea){t._oPreviewArea.style.cursor="grab"}r.show(t._getI18nText("renderSuccess"))}).catch(function(e){console.error("[Diagram] Mermaid 渲染错误:",e);t._showRenderError(e.message||e.str||"Mermaid 语法错误")})}catch(e){console.error("[Diagram] Mermaid 渲染异常:",e);this._showRenderError(e.message||"渲染异常")}},_showRenderError:function(e){var t=this.getView().getModel("diagram");if(this._oContentWrapper){this._oContentWrapper.innerHTML='<div class="renderErrorContainer">'+'  <div class="renderErrorIcon">⚠️</div>'+'  <div class="renderErrorTitle">'+this._getI18nText("renderFailed")+"</div>"+'  <div class="renderErrorMessage">'+this._escapeHtml(e)+"</div>"+'  <div class="renderErrorHint">请检查 Mermaid 语法，或点击左侧"修复输出格式"按钮</div>'+"</div>"}t.setProperty("/showFixButton",true);t.setProperty("/errorMessage",e)},onCopyMermaid:function(){var e=this;var t=this.getView().getModel("diagram");var i=t.getProperty("/mermaidCode");if(!i){r.show(this._getI18nText("noMermaidCode"));return}this._copyTextToClipboard(i).then(function(){r.show(e._getI18nText("mermaidCopied"))}).catch(function(){r.show(e._getI18nText("copyFailed"))})},onViewModeChange:function(e){var t=e.getParameter("item").getKey();var r=this.getView().getModel("diagram");r.setProperty("/viewMode",t);if(!this._oContentWrapper)return;var i=r.getProperty("/mermaidCode");if(t==="code"){this._oContentWrapper.innerHTML='<pre class="mermaidCodeView"><code>'+this._escapeHtml(i||"暂无 Mermaid 代码")+"</code></pre>"}else{if(i){this._renderMermaid(i)}else{this._oContentWrapper.innerHTML='<div class="diagramPlaceholder">'+'<span class="sapUiIcon" style="font-family:SAP-icons;font-size:4rem;color:#bbb;">&#xe145;</span>'+"<p>输入描述并点击生成按钮来创建流程图</p>"+"</div>"}}},onZoomIn:function(){var e=this.getView().getModel("diagram");var t=e.getProperty("/zoomLevel");t=Math.min(t+this._ZOOM_STEP,this._MAX_ZOOM);e.setProperty("/zoomLevel",t);this._applyZoom(t)},onZoomOut:function(){var e=this.getView().getModel("diagram");var t=e.getProperty("/zoomLevel");t=Math.max(t-this._ZOOM_STEP,this._MIN_ZOOM);e.setProperty("/zoomLevel",t);this._applyZoom(t)},onResetZoom:function(){var e=this.getView().getModel("diagram");e.setProperty("/zoomLevel",1);this._applyZoom(1);if(this._oPreviewArea){this._oPreviewArea.scrollLeft=0;this._oPreviewArea.scrollTop=0}},_applyZoom:function(e){var t=this._oContentWrapper?this._oContentWrapper.querySelector(".mermaidRenderContainer"):null;if(t&&this._oRenderedSvg){var r=this._oRenderedSvg;if(!this._nOriginalWidth){var i=r.getBoundingClientRect();var a=this.getView().getModel("diagram");var n=a.getProperty("/zoomLevel")||1;this._nOriginalWidth=i.width/n;this._nOriginalHeight=i.height/n}var o=this._nOriginalWidth*e;var s=this._nOriginalHeight*e;r.style.width=o+"px";r.style.height=s+"px";r.style.transform="none";t.style.width="auto";t.style.height="auto";t.style.display="inline-block"}},onDownloadPNG:function(){var e=this;if(!this._oRenderedSvg){r.show(this._getI18nText("noImageToDownload"));return}this._svgToPng(this._oRenderedSvg,function(t){e._downloadFile(t,"diagram-"+Date.now()+".png");r.show(e._getI18nText("downloadStarted"))})},onDownloadSVG:function(){if(!this._oRenderedSvg){r.show(this._getI18nText("noImageToDownload"));return}var e=(new XMLSerializer).serializeToString(this._oRenderedSvg);var t=new Blob([e],{type:"image/svg+xml;charset=utf-8"});var i=URL.createObjectURL(t);this._downloadFile(i,"diagram-"+Date.now()+".svg");URL.revokeObjectURL(i);r.show(this._getI18nText("downloadStarted"))},onCopyImage:function(){var e=this;if(!this._oRenderedSvg){r.show(this._getI18nText("noImageToCopy"));return}if(!navigator.clipboard||!navigator.clipboard.write){r.show(this._getI18nText("clipboardNotSupported"));return}this._svgToPng(this._oRenderedSvg,function(t){fetch(t).then(function(e){return e.blob()}).then(function(e){var t=new ClipboardItem({"image/png":e});return navigator.clipboard.write([t])}).then(function(){r.show(e._getI18nText("imageCopied"))}).catch(function(t){console.error("[Diagram] 复制图片失败:",t);r.show(e._getI18nText("copyImageFailed"))})})},_svgToPng:function(e,t){var r=(new XMLSerializer).serializeToString(e);var i=document.createElement("canvas");var a=i.getContext("2d");var n=new Image;var o=e.getBoundingClientRect();var s=o.width||e.viewBox.baseVal.width||800;var d=o.height||e.viewBox.baseVal.height||600;var l=2;i.width=s*l;i.height=d*l;a.scale(l,l);a.fillStyle="#ffffff";a.fillRect(0,0,s,d);n.onload=function(){a.drawImage(n,0,0,s,d);t(i.toDataURL("image/png"))};n.onerror=function(){console.error("[Diagram] SVG 转 PNG 失败")};var c=btoa(unescape(encodeURIComponent(r)));n.src="data:image/svg+xml;base64,"+c},_downloadFile:function(e,t){var r=document.createElement("a");r.download=t;r.href=e;document.body.appendChild(r);r.click();document.body.removeChild(r)},_copyTextToClipboard:function(e){if(navigator.clipboard&&navigator.clipboard.writeText){return navigator.clipboard.writeText(e)}return new Promise(function(t,r){var i=document.createElement("textarea");i.value=e;i.setAttribute("readonly","");i.style.position="absolute";i.style.left="-9999px";document.body.appendChild(i);i.select();try{var a=document.execCommand("copy");if(a){t()}else{r(new Error("copy failed"))}}catch(e){r(e)}finally{document.body.removeChild(i)}})},onOpenInDrawio:function(){var e=this;var t=this.getView().getModel("diagram");var i=t.getProperty("/mermaidCode");if(!i){r.show(this._getI18nText("noMermaidCode"));return}this._copyTextToClipboard(i).then(function(){r.show("Mermaid 代码已复制，请在编辑器中 Arrange → Insert → Advanced → Mermaid 粘贴")}).catch(function(){console.warn("[Diagram] 复制失败")});if(!this._oDrawioDialog){this._bDrawioLoading=true;sap.ui.core.Fragment.load({id:this.getView().getId(),name:"com.ai.assistant.aichatapp.view.DrawioDialog",controller:this}).then(function(t){e._oDrawioDialog=t;e.getView().addDependent(t);e._bDrawioLoading=false;t.open();setTimeout(function(){e._initDrawioEmbed()},300)}).catch(function(t){console.error("[Diagram] Fragment 加载失败:",t);e._bDrawioLoading=false});return}if(this._bDrawioLoading){return}this._oDrawioDialog.open();setTimeout(function(){e._initDrawioEmbed()},300)},_initDrawioEmbed:function(){var e=this;var t=sap.ui.core.Fragment.byId(this.getView().getId(),"drawioIframeBox");if(!t)return;var r=t.getDomRef();if(!r){setTimeout(function(){e._initDrawioEmbed()},200);return}r.innerHTML="";var i=document.createElement("iframe");i.id=this.getView().getId()+"--drawioFrame";i.style.cssText="width:100%;height:100%;min-height:600px;border:none;background:#fff;";i.setAttribute("allowfullscreen","true");i.setAttribute("allow","clipboard-read; clipboard-write");r.appendChild(i);this._oDrawioIframe=i;var a="https://embed.diagrams.net/?embed=1&proto=json&spin=1"+"&ui=kennedy"+"&libraries=1"+"&noSaveBtn=0"+"&saveAndExit=0"+"&noExitBtn=1";i.src=a;this._fnDrawioHandler=function(t){if(t.origin!=="https://embed.diagrams.net")return;try{var r=JSON.parse(t.data);e._handleDrawioMsg(r)}catch(e){}};window.addEventListener("message",this._fnDrawioHandler)},_handleDrawioMsg:function(e){var t=this._oDrawioIframe;if(!t||!t.contentWindow)return;switch(e.event){case"configure":t.contentWindow.postMessage(JSON.stringify({action:"configure",config:{css:".geMenubarContainer { background: #f5f5f5 !important; }",defaultFonts:["Microsoft YaHei","SimHei","Arial"],enabledLibraries:["general","basic","arrows2","flowchart","uml"]}}),"*");break;case"init":t.contentWindow.postMessage(JSON.stringify({action:"load",xml:"",autosave:0}),"*");break;case"export":this._handleDrawioExport(e);break;case"save":r.show("图表已保存");break;case"exit":this.onCloseDrawio();break}},_handleDrawioExport:function(e){if(e.format==="png"&&e.data){this._downloadFile(e.data,"diagram-"+Date.now()+".png");r.show(this._getI18nText("exportSuccess"))}else if(e.format==="svg"&&e.data){this._downloadFile(e.data,"diagram-"+Date.now()+".svg");r.show(this._getI18nText("exportSuccess"))}},onDrawioExportPNG:function(){if(this._oDrawioIframe&&this._oDrawioIframe.contentWindow){this._oDrawioIframe.contentWindow.postMessage(JSON.stringify({action:"export",format:"png",scale:2,background:"#ffffff"}),"*")}},onDrawioExportSVG:function(){if(this._oDrawioIframe&&this._oDrawioIframe.contentWindow){this._oDrawioIframe.contentWindow.postMessage(JSON.stringify({action:"export",format:"svg"}),"*")}},onDrawioCopyImage:function(){var e=this;if(!this._oDrawioIframe||!this._oDrawioIframe.contentWindow)return;var t=function(i){if(i.origin!=="https://embed.diagrams.net")return;try{var a=JSON.parse(i.data);if(a.event==="export"&&a.format==="png"&&a.data){window.removeEventListener("message",t);fetch(a.data).then(function(e){return e.blob()}).then(function(e){return navigator.clipboard.write([new ClipboardItem({"image/png":e})])}).then(function(){r.show(e._getI18nText("imageCopied"))}).catch(function(){r.show(e._getI18nText("copyImageFailed"))})}}catch(e){}};window.addEventListener("message",t);this._oDrawioIframe.contentWindow.postMessage(JSON.stringify({action:"export",format:"png",scale:2,background:"#ffffff"}),"*")},onCloseDrawio:function(){if(this._oDrawioDialog){this._oDrawioDialog.close()}if(this._fnDrawioHandler){window.removeEventListener("message",this._fnDrawioHandler);this._fnDrawioHandler=null}if(this._oDrawioIframe){this._oDrawioIframe.src="about:blank";this._oDrawioIframe=null}},_getI18nText:function(e){var t=this.getView().getModel("i18n");if(t){return t.getResourceBundle().getText(e)}return e},_escapeHtml:function(e){if(!e)return"";var t=document.createElement("div");t.textContent=e;return t.innerHTML},onExit:function(){}})});
//# sourceMappingURL=Diagram.controller.js.map