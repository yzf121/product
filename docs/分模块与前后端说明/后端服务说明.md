# 后端服务说明

> **技术栈**: SAP CAP (Cloud Application Programming) + Node.js  
> **框架版本**: @sap/cds ^9  
> **运行时**: Node.js >= 18.0.0

---

## 📁 目录结构

```
srv/
├── chat-service.cds    # CDS 服务定义
├── chat-service.js     # CDS 服务实现（备用非流式接口）
└── server.js           # 自定义服务器（流式响应 + 文件上传）
```

---

## 🏗️ 架构概述

后端服务采用 SAP CAP 框架，并扩展了自定义 Express 路由以支持流式响应和文件上传等高级功能。

### 请求流程

```
┌──────────┐    ┌─────────────┐    ┌─────────────┐    ┌──────────────┐
│  前端     │ -> │   CAP 框架   │ -> │ server.js   │ -> │ 阿里云百炼 API │
│  UI5     │    │   Express   │    │ 自定义路由   │    │  DashScope   │
└──────────┘    └─────────────┘    └─────────────┘    └──────────────┘
```

---

## ⚙️ 环境变量配置

### 必需配置

```bash
# .env 文件

# ==================== DashScope API 配置 ====================
# 用于 AI 对话功能
DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxxxxx

# 各 AI 助手的应用 ID
DASHSCOPE_APP_ID=xxxxxxxx              # 默认应用 ID
DASHSCOPE_APP_ID_ABAP=xxxxxxxx         # ABAP Clean Core 助手
DASHSCOPE_APP_ID_CPI=xxxxxxxx          # CPI 集成助手
DASHSCOPE_APP_ID_FUNC_DOC=xxxxxxxx     # 功能文档生成
DASHSCOPE_APP_ID_TECH_DOC=xxxxxxxx     # 技术文档生成
DASHSCOPE_APP_ID_CODE_REVIEW=xxxxxxxx  # 代码审查助手
DASHSCOPE_APP_ID_UNIT_TEST=xxxxxxxx    # 单元测试生成
DASHSCOPE_APP_ID_DIAGRAM=xxxxxxxx      # 流程图生成

# ==================== 百炼 OpenAPI 配置 ====================
# 用于文件上传功能（使用 RAM AccessKey，非 DashScope API Key）
# 在 server.js 中的变量映射：
#   - BAILIAN_AK → process.env.BAILIAN_ACCESS_KEY_ID
#   - BAILIAN_SK → process.env.BAILIAN_ACCESS_KEY_SECRET
#   - BAILIAN_WORKSPACE_ID → process.env.BAILIAN_WORKSPACE_ID

BAILIAN_ACCESS_KEY_ID=LTAI5txxxxxxxxxx
BAILIAN_ACCESS_KEY_SECRET=xxxxxxxxxx
BAILIAN_WORKSPACE_ID=llm-njsp72bv281ofywg  # 业务空间 ID（默认值）
```

### 安全提示

⚠️ **重要安全事项**:
- `.env` 文件已添加到 `.gitignore`，切勿提交到版本控制
- API 密钥仅在后端使用，禁止返回给前端
- 禁止在日志中打印完整密钥

---

## 🔌 API 接口

### 1. 流式聊天接口

#### 接口信息

| 属性 | 值 |
|-----|-----|
| **端点** | `POST /api/chat/stream` |
| **协议** | HTTP + Server-Sent Events (SSE) |
| **Content-Type** | `application/json` |

#### 请求参数

```typescript
interface ChatStreamRequest {
    message: string;           // 必需 - 用户消息内容
    aiType?: string;           // 可选 - AI 助手类型，默认 abap-clean-core
    sessionId?: string;        // 可选 - 百炼 session_id
    messages?: Message[];      // 可选 - 历史消息（降级模式）
    sessionInfo?: SessionInfo; // 可选 - 会话信息
    sessionFileIds?: string[]; // 可选 - 会话文件 ID 列表
}

interface Message {
    role: "user" | "assistant";
    content: string;
}

interface SessionInfo {
    createdAt: string;  // ISO 8601 格式
    roundCount: number; // 当前轮次
}
```

#### 请求示例

```json
{
    "message": "请帮我重构这段 ABAP 代码",
    "aiType": "abap-clean-core",
    "sessionId": "session_abc123",
    "sessionInfo": {
        "createdAt": "2025-01-08T10:00:00Z",
        "roundCount": 5
    },
    "sessionFileIds": ["file_session_xyz789"]
}
```

#### 响应格式

SSE 格式流式响应：

```
# 正常响应
data: {"text": "我来帮你分析这段代码", "sessionId": "session_abc123"}

data: {"text": "首先，我们需要...", "sessionId": "session_abc123"}

data: [DONE]

# 错误响应
data: {"error": "AI服务配置不完整，请联系管理员"}
```

#### 支持的 aiType 值

| aiType | 描述 | 环境变量 |
|--------|------|---------|
| `abap-clean-core` | ABAP Clean Core 助手 | `DASHSCOPE_APP_ID_ABAP`（未配置时回退 `DASHSCOPE_APP_ID`） |
| `cpi` | CPI 集成助手 | `DASHSCOPE_APP_ID_CPI` |
| `func-doc` | 功能文档生成 | `DASHSCOPE_APP_ID_FUNC_DOC` |
| `tech-doc` | 技术文档生成 | `DASHSCOPE_APP_ID_TECH_DOC` |
| `code-review` | 代码审查助手 | `DASHSCOPE_APP_ID_CODE_REVIEW` |
| `unit-test` | 单元测试生成 | `DASHSCOPE_APP_ID_UNIT_TEST` |
| `diagram` | 流程图生成 | `DASHSCOPE_APP_ID_DIAGRAM` |

> **默认值**: 未传 `aiType` 时默认使用 `abap-clean-core`。

---

### 2. 文件上传接口

#### 接口信息

| 属性 | 值 |
|-----|-----|
| **端点** | `POST /api/files/session` |
| **协议** | HTTP |
| **Content-Type** | `multipart/form-data` |

#### 请求参数

| 参数 | 类型 | 必需 | 描述 |
|-----|------|-----|------|
| `file` | File | 是 | 要上传的文件 |

#### 响应格式

```typescript
interface FileUploadResponse {
    fileId: string;      // 文件 ID (file_session_xxx)
    fileName: string;    // 原始文件名
    size: number;        // 文件大小（字节）
    status: string;      // 状态：UPLOADING
    message: string;     // 提示信息
}

interface FileUploadError {
    error: string;       // 错误信息
    code: string;        // 错误代码
}
```

#### 响应示例

**成功**:
```json
{
    "fileId": "file_session_abc123def456",
    "fileName": "document.pdf",
    "size": 1024000,
    "status": "UPLOADING",
    "message": "文件已上传，正在解析中..."
}
```

**失败**:
```json
{
    "error": "文件过大，最大支持 50MB",
    "code": "FILE_TOO_LARGE"
}
```

#### 错误代码

| 代码 | 描述 |
|-----|------|
| `CONFIG_ERROR` | 文件上传服务未配置 |
| `NO_FILE` | 未选择文件 |
| `FILE_TOO_LARGE` | 文件超过大小限制 |
| `UPLOAD_ERROR` | 上传过程中出错 |

---

### 3. 文件状态查询接口

#### 接口信息

| 属性 | 值 |
|-----|-----|
| **端点** | `GET /api/files/session/:fileId/status` |
| **协议** | HTTP |

#### 路径参数

| 参数 | 描述 |
|-----|------|
| `fileId` | 文件 ID |

#### 响应格式

```typescript
interface FileStatusResponse {
    fileId: string;      // 文件 ID
    fileName: string;    // 文件名
    rawStatus: string;   // 原始状态
    status: string;      // 简化状态
    message: string;     // 状态描述
}
```

#### 状态映射

| 原始状态 | 简化状态 | 描述 |
|---------|---------|------|
| `INIT` | `processing` | 初始化中 |
| `PARSING` | `processing` | 解析中 |
| `PARSE_SUCCESS` | `processing` | 解析成功，正在索引 |
| `FILE_IS_READY` | `ready` | 文件已就绪，可使用 |
| `PARSE_FAILED` | `error` | 解析失败 |
| `SAFE_CHECK_FAILED` | `error` | 安全检查失败 |
| `INDEX_BUILDING_FAILED` | `error` | 索引构建失败 |
| `FILE_EXPIRED` | `error` | 文件已过期 |

---

### 4. CDS 服务接口（备用）

#### 服务定义

```cds
// srv/chat-service.cds
service ChatService @(path: '/api/chat') {
    action sendMessage(message: String, sessionId: String) returns String;
}
```

这是一个备用的非流式接口，一般不使用。

---

## 🔧 核心实现

### server.js 结构

```javascript
// ===================== 环境变量配置 =====================
const DASHSCOPE_API_KEY = process.env.DASHSCOPE_API_KEY;
const BAILIAN_AK = process.env.BAILIAN_ACCESS_KEY_ID;
const BAILIAN_SK = process.env.BAILIAN_ACCESS_KEY_SECRET;
const BAILIAN_WORKSPACE_ID = process.env.BAILIAN_WORKSPACE_ID || 'llm-njsp72bv281ofywg';
// ...

// AI 类型映射
const AI_APP_ID_MAP = { /* ... */ };

// 配置常量
const SESSION_CONFIG = { /* ... */ };
const FILE_UPLOAD_CONFIG = { /* ... */ };

// ===================== 函数定义 =====================

// AI 应用 ID 获取
function getAppIdByType(aiType) { /* ... */ }
function buildApiUrl(appId) { /* ... */ }

// 百炼 SDK 客户端
function createBailianClient() { /* ... */ }
function getBailianClient() { /* ... */ }

// ===================== 文件上传处理函数 =====================
async function applyFileUploadLease(fileName, fileSize, fileMd5) { /* ... */ }
async function uploadToLeaseUrl(leaseData, fileBuffer) { /* ... */ }
async function addSessionFile(leaseId) { /* ... */ }
async function describeFile(fileId) { /* ... */ }
async function waitForFileReady(fileId, maxWaitMs) { /* ... */ }

// ===================== session_id 辅助函数 =====================
function shouldUseSessionId(sessionId, sessionInfo) { /* ... */ }

// ===================== 端口检测辅助函数 =====================
function isPortAvailable(port) { /* ... */ }
async function findAvailablePort(startPort, maxAttempts) { /* ... */ }

// ===================== CDS 服务器扩展 =====================
cds.on('bootstrap', (app) => {
    // 注册文件上传接口
    // POST /api/files/session
    // GET /api/files/session/:fileId/status
    
    // 注册流式聊天接口
    // POST /api/chat/stream
});

cds.on('listening', ({ server, url }) => {
    // 服务器启动回调
});

// 自定义端口绑定
module.exports = async function (options) {
    // 端口自动切换逻辑
};
```

### 会话管理策略

```javascript
const SESSION_CONFIG = {
    MAX_ROUNDS: 50,        // 百炼 API 限制：最多 50 轮
    EXPIRE_HOURS: 1,       // 百炼 API 限制：1 小时过期
    FALLBACK_ROUNDS: 10    // 降级时使用的历史轮数
};

function shouldUseSessionId(sessionId, sessionInfo) {
    // 1. 检查 sessionId 是否存在
    if (!sessionId || !sessionInfo) return false;
    
    // 2. 检查轮次
    if (sessionInfo.roundCount >= SESSION_CONFIG.MAX_ROUNDS) return false;
    
    // 3. 检查时间
    const expireTime = SESSION_CONFIG.EXPIRE_HOURS * 60 * 60 * 1000;
    if (Date.now() - new Date(sessionInfo.createdAt).getTime() > expireTime) {
        return false;
    }
    
    return true;
}
```

### 文件上传流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      文件上传完整流程                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  前端                    后端                    阿里云百炼      │
│                                                                 │
│  选择文件 ──────────────> POST /api/files/session               │
│                              │                                  │
│                              │  1. 验证文件                     │
│                              │  2. 计算 MD5                     │
│                              │  3. 调用 ApplyFileUploadLease    │
│                              │         ─────────────────────>   │
│                              │  <──────── 返回上传凭证          │
│                              │                                  │
│                              │  4. 上传到 OSS 预签名 URL        │
│                              │         ─────────────────────>   │
│                              │                                  │
│                              │  5. 调用 AddFile                 │
│                              │         ─────────────────────>   │
│                              │  <──────── 返回 file_session_id  │
│                              │                                  │
│  <───────────────────────   返回 fileId + 状态                  │
│                                                                 │
│  轮询状态 ──────────────> GET /api/files/session/:id/status     │
│                              │                                  │
│                              │  调用 DescribeFile               │
│                              │         ─────────────────────>   │
│                              │  <──────── 返回文件状态          │
│                              │                                  │
│  <───────────────────────   返回状态（ready/processing/error）  │
│                                                                 │
│  发送消息（携带 fileId）──> POST /api/chat/stream               │
│                              │                                  │
│                              │  请求中包含 rag_options:         │
│                              │  { session_file_ids: [...] }     │
│                              │         ─────────────────────>   │
│                              │                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 文件上传配置

```javascript
const FILE_UPLOAD_CONFIG = {
    MAX_FILE_SIZE: 50 * 1024 * 1024,  // 50MB
    MAX_FILES_PER_SESSION: 5,          // 单会话最多 5 个文件
    ALLOWED_EXTENSIONS: [
        '.pdf', '.doc', '.docx',       // 文档
        '.txt', '.md',                 // 文本
        '.json', '.xml', '.csv',       // 数据
        '.xlsx', '.xls',               // Excel
        '.ppt', '.pptx'                // PowerPoint
    ],
    PARSE_TIMEOUT: 120000,             // 解析超时 120 秒
    POLL_INTERVAL: 2000                // 轮询间隔 2 秒
};
```

### 端口自动切换

```javascript
async function findAvailablePort(startPort, maxAttempts = 10) {
    for (let i = 0; i < maxAttempts; i++) {
        const port = startPort + i;
        const available = await isPortAvailable(port);
        if (available) {
            if (i > 0) {
                console.log(`[cds] - 端口 ${startPort} 被占用，自动切换到端口 ${port}`);
            }
            return port;
        }
        console.log(`[cds] - 端口 ${port} 被占用，尝试下一个...`);
    }
    throw new Error(`无法找到可用端口（已尝试 ${startPort} - ${startPort + maxAttempts - 1}）`);
}
```

---

## 🔗 阿里云百炼集成

### SDK 依赖

```json
{
    "@alicloud/bailian20231229": "^1.0.0",
    "@alicloud/openapi-client": "^0.4.0",
    "@alicloud/tea-util": "^1.4.0"
}
```

### SDK 客户端创建

```javascript
const Bailian = require('@alicloud/bailian20231229');
const OpenApi = require('@alicloud/openapi-client');
const Util = require('@alicloud/tea-util');

function createBailianClient() {
    const config = new OpenApi.Config({
        accessKeyId: BAILIAN_AK,
        accessKeySecret: BAILIAN_SK,
    });
    config.endpoint = 'bailian.cn-beijing.aliyuncs.com';
    return new Bailian.default(config);
}
```

### API 调用方式

| 功能 | API 类型 | 认证方式 |
|-----|---------|---------|
| AI 对话 | DashScope Apps API | Bearer Token (API Key) |
| 文件上传 | 百炼 OpenAPI | AK/SK 签名 |

### DashScope Apps API 调用

```javascript
const apiUrl = `https://dashscope.aliyuncs.com/api/v1/apps/${appId}/completion`;

const response = await fetch(apiUrl, {
    method: 'POST',
    headers: {
        'Authorization': `Bearer ${DASHSCOPE_API_KEY}`,
        'Content-Type': 'application/json',
        'X-DashScope-SSE': 'enable',
        'X-DashScope-WorkSpace': BAILIAN_WORKSPACE_ID
    },
    body: JSON.stringify({
        input: {
            prompt: message,
            session_id: sessionId  // 或 messages
        },
        parameters: {
            incremental_output: true,
            rag_options: {
                session_file_ids: sessionFileIds
            }
        }
    })
});
```

---

## 📊 日志输出

### 日志前缀

| 前缀 | 描述 |
|-----|------|
| `[cds]` | CDS 框架日志 |
| `[AI]` | AI 服务调用日志 |
| `[FileUpload]` | 文件上传日志 |

### 日志示例

```
[cds] - 服务器已启动: http://localhost:4004
[cds] - 访问应用: http://localhost:4004/ai-chat-gui/webapp/index.html
[AI] 已配置的助手:
  - abap-clean-core: abc12345...
  - cpi: def78901...
[AI] 使用 abap-clean-core 助手，应用ID: abc12345...
[AI] 使用 session_id 模式，轮次: 5
[FileUpload] 开始处理文件: document.pdf, 大小: 1024000, MD5: abc123...
[FileUpload] 申请上传租约: document.pdf, 大小: 1024000 bytes
[FileUpload] 获取租约成功: lease_abc12345...
[FileUpload] 开始上传到OSS: https://xxx.oss-cn-beijing.aliyuncs.com/...
[FileUpload] 文件上传到OSS成功
[FileUpload] 文件ID: file_session_xyz789
[FileUpload] 文件状态: FILE_IS_READY
```

---

## 🛡️ 安全配置

### CORS 配置

```javascript
// CORS 预检请求处理 - 聊天接口
app.options('/api/chat/stream', (_req, res) => {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    res.status(200).end();
});

// CORS 预检请求处理 - 文件上传接口
app.options('/api/files/*', (_req, res) => {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    res.status(200).end();
});
```

### 认证配置

- **本地开发**: 无认证（方便调试）
- **云端部署**: XSUAA OAuth2 认证

在 `package.json` 中配置：

```json
{
    "cds": {
        "requires": {
            "[production]": {
                "auth": "xsuaa"
            }
        }
    }
}
```

---

## 📝 开发指南

### 添加新的 AI 助手

1. **添加环境变量**:
```bash
# .env
DASHSCOPE_APP_ID_NEW_ASSISTANT=xxxxxxxx
```

2. **更新 AI_APP_ID_MAP**:
```javascript
const AI_APP_ID_MAP = {
    // ... 现有配置
    'new-assistant': process.env.DASHSCOPE_APP_ID_NEW_ASSISTANT,
};
```

3. **重启服务器**

### 添加新的 API 端点

```javascript
cds.on('bootstrap', (app) => {
    // 添加新的路由
    app.post('/api/new-endpoint', async (req, res) => {
        // 处理逻辑
        res.json({ success: true });
    });
});
```

### 调试技巧

1. **查看环境变量加载**:
   - 检查终端输出的 `[AI] 已配置的助手` 日志

2. **查看 API 调用详情**:
   - 在 `getAppIdByType`、`applyFileUploadLease` 等函数中添加 `console.log`

3. **使用 Postman 测试 API**:
   - 导入请求集合进行接口测试

---

## ⚠️ 注意事项

1. **鉴权区分**:
   - AI 对话使用 `DASHSCOPE_API_KEY`
   - 文件上传使用 `BAILIAN_ACCESS_KEY_ID/SECRET`

2. **业务空间一致性**:
   - 文件和应用必须在同一 `BAILIAN_WORKSPACE_ID` 下

3. **会话文件有效期**:
   - 会话文件是临时有效的，过期需重新上传

4. **超时处理**:
   - API 请求超时设置为 60 秒
   - 文件解析超时设置为 120 秒

5. **错误处理**:
   - 所有 API 错误都会返回 JSON 格式的错误信息
   - SSE 流中的错误也会以 JSON 格式发送
