# 项目架构说明

> **版本**: v1.4.3  
> **技术栈**: SAP CAP + SAP UI5 + 阿里云百炼

---

## 🏗️ 整体架构

### 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           用户浏览器                                     │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                    SAP UI5 Freestyle 前端                          │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐   │ │
│  │  │   Home   │  │   Main   │  │ Diagram  │  │    Component     │   │ │
│  │  │  首页    │  │  聊天    │  │  流程图  │  │   状态管理       │   │ │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────────────┘   │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │ HTTP/SSE
┌───────────────────────────────────┼─────────────────────────────────────┐
│                          SAP BTP / Cloud Foundry                        │
│  ┌────────────────────────────────┴───────────────────────────────────┐ │
│  │         HTML5 Runtime / Launchpad (Work Zone)                       │ │
│  │            (认证 + 路由转发 / HTML5 运行时)                           │ │
│  └────────────────────────────────┬───────────────────────────────────┘ │
│                                   │                                      │
│  ┌────────────────────────────────┴───────────────────────────────────┐ │
│  │                     CAP Node.js Backend                             │ │
│  │  ┌─────────────────┐  ┌─────────────────────────────────────────┐  │ │
│  │  │  CDS Service    │  │           server.js                      │  │ │
│  │  │  (备用)         │  │  ┌─────────────────────────────────────┐ │  │ │
│  │  └─────────────────┘  │  │ 流式聊天 API (/api/chat/stream)     │ │  │ │
│  │                       │  ├─────────────────────────────────────┤ │  │ │
│  │                       │  │ 文件上传 API (/api/files/session)   │ │  │ │
│  │                       │  ├─────────────────────────────────────┤ │  │ │
│  │                       │  │ AI 类型路由 + 会话管理              │ │  │ │
│  │                       │  └─────────────────────────────────────┘ │  │ │
│  │                       └─────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                   │                                      │
│  ┌─────────────┐  ┌─────────────┐ │ ┌─────────────┐                     │
│  │   XSUAA    │  │ Destination │ │ │ HTML5 Repo  │                     │
│  │   认证服务  │  │   服务      │ │ │  前端托管   │                     │
│  └─────────────┘  └─────────────┘ │ └─────────────┘                     │
└───────────────────────────────────┼─────────────────────────────────────┘
                                    │ HTTPS
┌───────────────────────────────────┼─────────────────────────────────────┐
│                           阿里云百炼平台                                 │
│  ┌────────────────────────────────┴───────────────────────────────────┐ │
│  │                      DashScope Apps API                             │ │
│  │                 (AI 对话 / 流式响应 / RAG)                          │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                      百炼 OpenAPI                                   │ │
│  │           (文件上传 / 解析 / 会话文件管理)                           │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📁 项目结构

### 目录层级

```
abap-clean-core-ai-fiori-new/
│
├── app/                              # 🎨 前端应用层
│   ├── ai-chat-gui/                  # AI 聊天 GUI 应用
│   │   ├── webapp/                   # UI5 Web 应用
│   │   │   ├── controller/           # MVC 控制器
│   │   │   ├── view/                 # XML 视图
│   │   │   ├── css/                  # 样式文件
│   │   │   ├── i18n/                 # 国际化
│   │   │   ├── Component.js          # 组件入口
│   │   │   └── manifest.json         # 应用描述符
│   │   ├── package.json              # 前端依赖
│   │   ├── ui5.yaml                  # UI5 配置
│   │   └── xs-app.json               # 路由配置
│   └── services.cds                  # 服务引用
│
├── srv/                              # 🔧 后端服务层
│   ├── server.js                     # 自定义服务器（核心）
│   ├── chat-service.cds              # CDS 服务定义
│   └── chat-service.js               # CDS 服务实现
│
├── db/                               # 💾 数据库层
│   └── schema.cds                    # 数据模型定义
│
├── docs/                             # 📚 文档
│   ├── 分模块与前后端说明/            # 详细说明文档
│   └── 项目说明文档.md               # 综合文档
│
├── .env                              # ⚙️ 环境变量（不提交）
├── .cdsrc.json                       # CDS 运行时配置
├── mta.yaml                          # MTA 部署配置
├── xs-security.json                  # 安全配置
├── package.json                      # 项目配置
└── README.md                         # 快速入门
```

---

## 🔄 数据流

### 聊天消息流

```
┌─────────────────────────────────────────────────────────────────────┐
│                           聊天消息流程                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  用户输入消息                                                        │
│       │                                                             │
│       ▼                                                             │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                 Main.controller.js                           │   │
│  │  1. onSendMessage() - 获取输入内容                           │   │
│  │  2. 渲染用户消息到界面                                        │   │
│  │  3. 构建请求体（message, aiType, sessionId, fileIds）        │   │
│  │  4. _callAIStream() - 发起 fetch 请求                        │   │
│  └───────────────────────────┬─────────────────────────────────┘   │
│                              │ POST /api/chat/stream                │
│                              ▼                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      server.js                               │   │
│  │  1. 解析请求体                                                │   │
│  │  2. getAppIdByType() - 获取对应 AI 应用 ID                   │   │
│  │  3. shouldUseSessionId() - 判断会话策略                      │   │
│  │  4. 构建百炼 API 请求                                         │   │
│  │  5. 设置 SSE 响应头                                           │   │
│  │  6. 调用百炼 API 并转发流式响应                               │   │
│  └───────────────────────────┬─────────────────────────────────┘   │
│                              │ SSE (Server-Sent Events)            │
│                              ▼                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              百炼 DashScope Apps API                         │   │
│  │  1. 处理请求                                                  │   │
│  │  2. 调用大模型                                                │   │
│  │  3. 返回流式响应（增量输出）                                   │   │
│  └───────────────────────────┬─────────────────────────────────┘   │
│                              │ data: {"text": "...", ...}          │
│                              ▼                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                 Main.controller.js                           │   │
│  │  1. 读取 SSE 流                                               │   │
│  │  2. _updateAIMessageContent() - 更新界面                     │   │
│  │  3. 保存 sessionId                                            │   │
│  │  4. _finalizeAIMessage() - 完成渲染                          │   │
│  │  5. 保存对话到 localStorage                                   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  显示 AI 回复                                                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 文件上传流

```
┌─────────────────────────────────────────────────────────────────────┐
│                           文件上传流程                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  用户选择文件                                                        │
│       │                                                             │
│       ▼                                                             │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              Main.controller.js                              │   │
│  │  1. onUploadFile() - 触发文件选择                            │   │
│  │  2. _handleFileSelect() - 验证文件                           │   │
│  │  3. _renderAttachmentCard() - 显示上传中状态                 │   │
│  │  4. _uploadFile() - 上传文件到后端                           │   │
│  └───────────────────────────┬─────────────────────────────────┘   │
│                              │ POST /api/files/session              │
│                              │ (multipart/form-data)                │
│                              ▼                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      server.js                               │   │
│  │  1. multer 解析文件                                           │   │
│  │  2. 计算 MD5                                                  │   │
│  │  3. applyFileUploadLease() - 申请上传租约                    │   │
│  │         │                                                    │   │
│  │         ▼ 百炼 OpenAPI                                       │   │
│  │     ┌─────────────────────────────────────────┐              │   │
│  │     │  ApplyFileUploadLease                   │              │   │
│  │     │  返回: 预签名 URL + 请求头              │              │   │
│  │     └────────────────────┬────────────────────┘              │   │
│  │                          │                                    │   │
│  │  4. uploadToLeaseUrl() - 上传到 OSS                          │   │
│  │         │                                                    │   │
│  │         ▼ OSS (PUT)                                          │   │
│  │     ┌─────────────────────────────────────────┐              │   │
│  │     │  阿里云 OSS 临时存储                    │              │   │
│  │     └────────────────────┬────────────────────┘              │   │
│  │                          │                                    │   │
│  │  5. addSessionFile() - 注册文件                              │   │
│  │         │                                                    │   │
│  │         ▼ 百炼 OpenAPI                                       │   │
│  │     ┌─────────────────────────────────────────┐              │   │
│  │     │  AddFile                                │              │   │
│  │     │  返回: file_session_xxx ID              │              │   │
│  │     └─────────────────────────────────────────┘              │   │
│  │                                                               │   │
│  │  6. 返回 fileId 给前端                                        │   │
│  └───────────────────────────┬─────────────────────────────────┘   │
│                              │ {fileId, status: "UPLOADING"}       │
│                              ▼                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              Main.controller.js                              │   │
│  │  1. 更新附件卡片状态                                         │   │
│  │  2. _pollFileStatus() - 开始轮询                             │   │
│  │         │                                                    │   │
│  │         ▼ 每 2 秒轮询                                        │   │
│  │  3. GET /api/files/session/:fileId/status                   │   │
│  │  4. 等待状态变为 "ready"                                     │   │
│  │  5. 更新 UI 显示"已就绪"                                     │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  文件就绪，可用于对话                                                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🔌 模块通信

### 前端模块关系

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Component.js                                │
│  (应用入口，管理全局状态和路由)                                       │
├─────────────────────────────────────────────────────────────────────┤
│                              │                                       │
│         ┌────────────────────┼────────────────────┐                 │
│         │                    │                    │                 │
│         ▼                    ▼                    ▼                 │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐         │
│  │    Home     │      │    Main     │      │   Diagram   │         │
│  │ Controller  │      │ Controller  │      │ Controller  │         │
│  │             │      │             │      │             │         │
│  │ - 磁贴导航   │ ──▶  │ - 聊天管理   │      │ - 图表生成   │         │
│  │ - 设置按钮   │      │ - 消息渲染   │      │ - Mermaid   │         │
│  │             │      │ - 文件上传   │      │ - Draw.io   │         │
│  └─────────────┘      └─────────────┘      └─────────────┘         │
│         │                    │                    │                 │
│         └────────────────────┼────────────────────┘                 │
│                              │                                       │
│                              ▼                                       │
│                    ┌─────────────────┐                              │
│                    │   chat Model    │                              │
│                    │ (JSONModel)     │                              │
│                    │                 │                              │
│                    │ - messages      │                              │
│                    │ - conversations │                              │
│                    │ - isLoading     │                              │
│                    └─────────────────┘                              │
│                              │                                       │
│                              ▼                                       │
│                    ┌─────────────────┐                              │
│                    │  localStorage   │                              │
│                    │  (持久化存储)    │                              │
│                    └─────────────────┘                              │
└─────────────────────────────────────────────────────────────────────┘
```

### 后端模块关系

```
┌─────────────────────────────────────────────────────────────────────┐
│                          server.js                                  │
│              (CDS 服务器扩展 + 自定义路由)                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  cds.on('bootstrap')                                                │
│         │                                                           │
│         ├──────────────────────┬──────────────────────┐             │
│         │                      │                      │             │
│         ▼                      ▼                      ▼             │
│  ┌─────────────┐        ┌─────────────┐        ┌─────────────┐     │
│  │ 聊天路由    │        │ 文件路由    │        │ CORS 处理   │     │
│  │             │        │             │        │             │     │
│  │ POST        │        │ POST        │        │ OPTIONS     │     │
│  │ /api/chat/  │        │ /api/files/ │        │ /*          │     │
│  │  stream     │        │  session    │        │             │     │
│  └──────┬──────┘        └──────┬──────┘        └─────────────┘     │
│         │                      │                                    │
│         │                      │                                    │
│  ┌──────┴──────────────────────┴──────┐                            │
│  │           辅助函数模块              │                            │
│  ├─────────────────────────────────────┤                            │
│  │ getAppIdByType()     - AI 类型路由  │                            │
│  │ buildApiUrl()        - 构建 API URL │                            │
│  │ shouldUseSessionId() - 会话策略     │                            │
│  │ findAvailablePort()  - 端口检测     │                            │
│  └─────────────────────────────────────┘                            │
│                                                                     │
│  ┌─────────────────────────────────────┐                            │
│  │         百炼 SDK 模块               │                            │
│  ├─────────────────────────────────────┤                            │
│  │ createBailianClient() - 创建客户端 │                            │
│  │ applyFileUploadLease() - 申请租约  │                            │
│  │ uploadToLeaseUrl()    - 上传到 OSS │                            │
│  │ addSessionFile()      - 注册文件   │                            │
│  │ describeFile()        - 查询状态   │                            │
│  │ waitForFileReady()    - 等待就绪   │                            │
│  └─────────────────────────────────────┘                            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🔐 安全架构

### 认证授权流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                        认证授权流程                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  开发环境                              生产环境                      │
│  ─────────                            ─────────                    │
│                                                                     │
│  ┌───────────┐                        ┌───────────┐                │
│  │  浏览器   │                        │  浏览器   │                │
│  └─────┬─────┘                        └─────┬─────┘                │
│        │                                    │                      │
│        ▼                                    ▼                      │
│  ┌───────────┐                        ┌───────────┐                │
│  │   直接    │                        │ HTML5 RT │                │
│  │   访问    │                        └─────┬─────┘                │
│  └─────┬─────┘                              │                      │
│        │                                    ▼                      │
│        │                              ┌───────────┐                │
│        │                              │  XSUAA    │                │
│        │                              │  认证     │                │
│        │                              └─────┬─────┘                │
│        │                                    │                      │
│        │                                    ▼                      │
│        │                              ┌───────────┐                │
│        │                              │ 角色检查  │                │
│        │                              │AIChat_User│                │
│        │                              └─────┬─────┘                │
│        │                                    │                      │
│        ▼                                    ▼                      │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                       CAP 后端服务                             │ │
│  │  ┌─────────────────────────────────────────────────────────┐  │ │
│  │  │                      API 密钥                            │  │ │
│  │  │  DASHSCOPE_API_KEY (环境变量，仅后端使用)                │  │ │
│  │  │  BAILIAN_AK/SK (环境变量，仅后端使用)                    │  │ │
│  │  └─────────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                              │                                      │
│                              ▼                                      │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                      阿里云百炼 API                            │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 密钥管理

```
┌─────────────────────────────────────────────────────────────────────┐
│                          密钥管理策略                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────┐      ┌─────────────────┐                      │
│  │     开发环境     │      │     生产环境     │                      │
│  ├─────────────────┤      ├─────────────────┤                      │
│  │                 │      │                 │                      │
│  │   .env 文件     │      │  BTP Cockpit    │                      │
│  │   (本地)       │      │  环境变量       │                      │
│  │                 │      │                 │                      │
│  │   不提交到 Git  │      │  加密存储       │                      │
│  │                 │      │                 │                      │
│  └────────┬────────┘      └────────┬────────┘                      │
│           │                        │                                │
│           └────────────┬───────────┘                                │
│                        │                                            │
│                        ▼                                            │
│           ┌────────────────────────┐                               │
│           │   process.env.*        │                               │
│           │   (服务端读取)          │                               │
│           └────────────────────────┘                               │
│                        │                                            │
│                        ▼                                            │
│           ┌────────────────────────┐                               │
│           │   安全规则              │                               │
│           ├────────────────────────┤                               │
│           │ ✓ 仅后端使用           │                               │
│           │ ✓ 不打印完整密钥       │                               │
│           │ ✓ 不返回给前端         │                               │
│           │ ✗ 禁止硬编码           │                               │
│           └────────────────────────┘                               │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 📊 性能考虑

### 流式响应

```
传统请求-响应模式:
用户 ──请求──> 服务器 ──等待──> AI ──完整响应──> 服务器 ──响应──> 用户
                            (可能需要 10-30 秒)

流式响应模式 (SSE):
用户 ──请求──> 服务器 ──请求──> AI ──chunk1──> 服务器 ──chunk1──> 用户
                               ──chunk2──> 服务器 ──chunk2──> 用户
                               ──chunk3──> 服务器 ──chunk3──> 用户
                               ...
                               ──[DONE]──> 服务器 ──[DONE]──> 用户

优势:
- 首字符响应时间 < 1 秒
- 用户体验更流畅
- 可随时中断
```

### 会话管理

```
session_id 模式 (优先):
┌─────────────────────────────────────────────────────────────────┐
│  请求体只包含当前消息 + session_id                              │
│  上下文由百炼平台云端存储                                        │
│  优点: 节省 token，请求体小                                     │
│  限制: 最多 50 轮，1 小时过期                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼ 超过限制
┌─────────────────────────────────────────────────────────────────┐
│  messages 模式 (降级):                                          │
│  请求体包含最近 10 轮历史消息                                    │
│  上下文由客户端管理                                              │
│  优点: 无轮次/时间限制                                          │
│  缺点: 消耗更多 token                                           │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 扩展性设计

### 添加新 AI 助手

```
1. 百炼控制台创建新应用
        │
        ▼
2. 添加环境变量
   .env: DASHSCOPE_APP_ID_NEW=xxx
        │
        ▼
3. 更新 AI_APP_ID_MAP (server.js)
   'new-assistant': process.env.DASHSCOPE_APP_ID_NEW
        │
        ▼
4. 添加 i18n 资源
   newAssistantTitle=New Assistant
   welcomeTitle_new-assistant=Welcome
        │
        ▼
5. 添加首页磁贴 (Home.view.xml)
   <GenericTile>...</GenericTile>
        │
        ▼
6. 完成！新助手可用
```

### 添加新功能模块

```
1. 创建视图
   view/NewFeature.view.xml
        │
        ▼
2. 创建控制器
   controller/NewFeature.controller.js
        │
        ▼
3. 添加路由 (manifest.json)
   routes: [{name: "newFeature", pattern: "new-feature"}]
   targets: {newFeature: {viewName: "NewFeature"}}
        │
        ▼
4. (可选) 添加后端 API (server.js)
   app.post('/api/new-feature', ...)
        │
        ▼
5. 完成！新功能可访问
```

---

## 📝 设计原则

### 前端设计原则

1. **组件化**: 使用 UI5 MVC 架构，视图与逻辑分离
2. **响应式**: 适配桌面、平板、手机
3. **国际化**: 所有文本使用 i18n 资源
4. **状态管理**: 使用 JSONModel 集中管理状态
5. **持久化**: localStorage 保存用户数据

### 后端设计原则

1. **无状态**: 服务器不存储会话状态
2. **流式优先**: 优先使用 SSE 流式响应
3. **安全隔离**: API 密钥仅后端使用
4. **错误处理**: 统一的错误响应格式
5. **可配置**: 通过环境变量配置

### 集成设计原则

1. **松耦合**: 前后端通过 HTTP API 通信
2. **标准协议**: 使用 REST + SSE 标准协议
3. **SDK 集成**: 使用官方 SDK 与第三方服务通信
4. **可替换**: AI 服务可通过配置切换
