# 数据持久化方案

> **版本**: v1.4.3  
> **更新日期**: 2025-01-08

---

## 📋 目录

1. [当前数据存储现状](#1-当前数据存储现状)
2. [阿里云数据库选型](#2-阿里云数据库选型)
3. [RDS MySQL 方案](#3-rds-mysql-方案)
4. [PolarDB 方案](#4-polardb-方案)
5. [表结构设计](#5-表结构设计)
6. [后端代码修改](#6-后端代码修改)
7. [部署配置](#7-部署配置)
8. [数据迁移](#8-数据迁移)

---

## 1. 当前数据存储现状

### 1.1 现状分析

目前项目的数据存储情况如下：

| 数据类型 | 存储位置 | 特点 | 问题 |
|---------|---------|------|------|
| 对话历史 | 浏览器 localStorage | 前端本地存储 | 换设备丢失、容量有限 |
| 会话状态 | 百炼 session_id | 云端存储 | 1小时过期、50轮限制 |
| 上传文件 | 百炼临时存储 | 会话级别 | 临时有效、不持久 |
| 用户配置 | 无 | 无持久化 | 每次重新设置 |

### 1.2 持久化需求

需要持久化的数据：

- ✅ **对话历史**: 用户的历史对话记录
- ✅ **用户配置**: 语言偏好、主题设置等
- ✅ **使用统计**: 调用次数、token 消耗等
- ⏳ **文件索引**: 已上传文件的元数据（可选）
- ⏳ **共享对话**: 多用户共享功能（可选）

---

## 2. 阿里云数据库选型

### 2.1 可选方案对比

| 方案 | 类型 | 适用场景 | 月费用（起） | 推荐度 |
|-----|------|---------|------------|--------|
| **RDS MySQL** | 关系型 | 中小型应用 | ¥70-200 | ⭐⭐⭐⭐⭐ |
| **PolarDB MySQL** | 云原生 | 大型应用 | ¥400+ | ⭐⭐⭐⭐ |
| **TableStore** | NoSQL | 海量数据 | 按量付费 | ⭐⭐⭐ |
| **MongoDB** | 文档型 | 灵活结构 | ¥200+ | ⭐⭐⭐ |

### 2.2 推荐方案

**推荐使用 RDS MySQL**，理由：

1. **成本低**: 入门配置月费约 ¥70-100
2. **兼容性好**: Node.js 生态支持完善
3. **运维简单**: 自动备份、监控告警
4. **扩展性**: 可平滑升级到 PolarDB

---

## 3. RDS MySQL 方案

### 3.1 创建 RDS 实例

1. 登录 [阿里云 RDS 控制台](https://rdsnext.console.aliyun.com/)
2. 点击 **创建实例**
3. 配置推荐：

| 配置项 | 推荐值 | 说明 |
|-------|-------|------|
| 数据库类型 | MySQL 8.0 | 最新稳定版 |
| 系列 | 基础版 | 开发/测试用 |
| 规格 | 1核1GB | 入门配置 |
| 存储类型 | ESSD云盘 | 高性能 |
| 存储空间 | 20GB | 可扩展 |
| 网络类型 | VPC | 私有网络 |
| 地域 | 同百炼/BTP | 减少延迟 |

### 3.2 配置数据库

创建实例后，进行以下配置：

#### 创建账号

```sql
-- 在 RDS 控制台创建账号
-- 用户名: ai_chat_user
-- 密码: <强密码>
-- 权限: 读写权限
```

#### 创建数据库

```sql
CREATE DATABASE ai_chat_db 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;
```

#### 配置白名单

添加以下 IP 到白名单：
- SAP BTP 出口 IP（部署时）
- 本地开发机器 IP（开发时）
- 或设置为 `0.0.0.0/0`（测试用，生产环境不推荐）

### 3.3 获取连接信息

在 RDS 控制台获取：

```
Host: rm-xxxxx.mysql.rds.aliyuncs.com
Port: 3306
Database: ai_chat_db
Username: ai_chat_user
Password: <你的密码>
```

---

## 4. PolarDB 方案

如果需要更高性能或更大规模，可选择 PolarDB：

### 4.1 创建 PolarDB 集群

1. 登录 [PolarDB 控制台](https://polardb.console.aliyun.com/)
2. 创建集群，选择 **MySQL 兼容版**
3. 推荐配置：

| 配置项 | 推荐值 |
|-------|-------|
| 版本 | MySQL 8.0 |
| 节点规格 | polar.mysql.x2.medium |
| 节点数 | 2（1主1只读） |
| 存储空间 | 按需付费 |

### 4.2 优势

- 存储与计算分离
- 读写分离自动支持
- 秒级弹性扩容
- 100% MySQL 兼容

---

## 5. 表结构设计

### 5.1 用户表

```sql
CREATE TABLE users (
    id VARCHAR(36) PRIMARY KEY,
    email VARCHAR(255) UNIQUE,
    name VARCHAR(100),
    avatar_url VARCHAR(500),
    preferences JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_email (email)
) ENGINE=InnoDB;
```

### 5.2 对话表

```sql
CREATE TABLE conversations (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    title VARCHAR(200),
    ai_type VARCHAR(50) NOT NULL,
    session_id VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted TINYINT(1) DEFAULT 0,
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_id (user_id),
    INDEX idx_ai_type (ai_type),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB;
```

### 5.3 消息表

```sql
CREATE TABLE messages (
    id VARCHAR(36) PRIMARY KEY,
    conversation_id VARCHAR(36) NOT NULL,
    role ENUM('user', 'assistant') NOT NULL,
    content TEXT NOT NULL,
    token_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE,
    INDEX idx_conversation_id (conversation_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB;
```

### 5.4 使用统计表

```sql
CREATE TABLE usage_stats (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    ai_type VARCHAR(50) NOT NULL,
    input_tokens INT DEFAULT 0,
    output_tokens INT DEFAULT 0,
    file_count INT DEFAULT 0,
    date DATE NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE KEY uk_user_date_type (user_id, date, ai_type),
    INDEX idx_date (date)
) ENGINE=InnoDB;
```

### 5.5 上传文件表（可选）

```sql
CREATE TABLE uploaded_files (
    id VARCHAR(36) PRIMARY KEY,
    conversation_id VARCHAR(36),
    user_id VARCHAR(36) NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_size BIGINT NOT NULL,
    file_type VARCHAR(50),
    bailian_file_id VARCHAR(100),
    status ENUM('uploading', 'ready', 'expired', 'error') DEFAULT 'uploading',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (conversation_id) REFERENCES conversations(id),
    INDEX idx_user_id (user_id),
    INDEX idx_status (status)
) ENGINE=InnoDB;
```

---

## 6. 后端代码修改

### 6.1 安装依赖

```bash
npm install mysql2 sequelize
# 或使用 knex
npm install knex mysql2
```

### 6.2 添加环境变量

```bash
# .env

# ==================== MySQL 数据库配置 ====================
DB_HOST=rm-xxxxx.mysql.rds.aliyuncs.com
DB_PORT=3306
DB_NAME=ai_chat_db
DB_USER=ai_chat_user
DB_PASSWORD=your_password
DB_SSL=true
```

### 6.3 数据库连接模块

创建 `srv/db.js`:

```javascript
const mysql = require('mysql2/promise');
require('dotenv').config();

// 数据库连接池
const pool = mysql.createPool({
    host: process.env.DB_HOST,
    port: parseInt(process.env.DB_PORT) || 3306,
    database: process.env.DB_NAME,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    ssl: process.env.DB_SSL === 'true' ? { rejectUnauthorized: true } : false,
    waitForConnections: true,
    connectionLimit: 10,
    queueLimit: 0
});

// 测试连接
async function testConnection() {
    try {
        const connection = await pool.getConnection();
        console.log('[DB] 数据库连接成功');
        connection.release();
        return true;
    } catch (error) {
        console.error('[DB] 数据库连接失败:', error.message);
        return false;
    }
}

module.exports = { pool, testConnection };
```

### 6.4 对话存储服务

创建 `srv/conversation-service.js`:

```javascript
const { pool } = require('./db');
const { v4: uuidv4 } = require('uuid');

class ConversationService {
    
    // 创建对话
    async createConversation(userId, aiType, title) {
        const id = uuidv4();
        const [result] = await pool.execute(
            `INSERT INTO conversations (id, user_id, ai_type, title) 
             VALUES (?, ?, ?, ?)`,
            [id, userId, aiType, title || '新对话']
        );
        return id;
    }
    
    // 获取用户对话列表
    async getConversations(userId, aiType = null, limit = 50) {
        let sql = `SELECT * FROM conversations 
                   WHERE user_id = ? AND is_deleted = 0`;
        const params = [userId];
        
        if (aiType) {
            sql += ' AND ai_type = ?';
            params.push(aiType);
        }
        
        sql += ' ORDER BY updated_at DESC LIMIT ?';
        params.push(limit);
        
        const [rows] = await pool.execute(sql, params);
        return rows;
    }
    
    // 添加消息
    async addMessage(conversationId, role, content) {
        const id = uuidv4();
        await pool.execute(
            `INSERT INTO messages (id, conversation_id, role, content) 
             VALUES (?, ?, ?, ?)`,
            [id, conversationId, role, content]
        );
        
        // 更新对话的 updated_at
        await pool.execute(
            `UPDATE conversations SET updated_at = CURRENT_TIMESTAMP 
             WHERE id = ?`,
            [conversationId]
        );
        
        return id;
    }
    
    // 获取对话消息
    async getMessages(conversationId, limit = 100) {
        const [rows] = await pool.execute(
            `SELECT * FROM messages 
             WHERE conversation_id = ? 
             ORDER BY created_at ASC 
             LIMIT ?`,
            [conversationId, limit]
        );
        return rows;
    }
    
    // 更新对话标题
    async updateTitle(conversationId, title) {
        await pool.execute(
            `UPDATE conversations SET title = ? WHERE id = ?`,
            [title, conversationId]
        );
    }
    
    // 删除对话（软删除）
    async deleteConversation(conversationId) {
        await pool.execute(
            `UPDATE conversations SET is_deleted = 1 WHERE id = ?`,
            [conversationId]
        );
    }
    
    // 更新 session_id
    async updateSessionId(conversationId, sessionId) {
        await pool.execute(
            `UPDATE conversations SET session_id = ? WHERE id = ?`,
            [sessionId, conversationId]
        );
    }
}

module.exports = new ConversationService();
```

### 6.5 在 server.js 中集成

```javascript
// server.js 添加以下内容

const { testConnection } = require('./db');
const conversationService = require('./conversation-service');

// 服务启动时测试数据库连接
cds.on('served', async () => {
    await testConnection();
});

// 新增 API: 获取对话列表
app.get('/api/conversations', async (req, res) => {
    try {
        const userId = req.user?.id || 'anonymous';
        const aiType = req.query.aiType;
        const conversations = await conversationService.getConversations(userId, aiType);
        res.json(conversations);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// 新增 API: 创建对话
app.post('/api/conversations', async (req, res) => {
    try {
        const userId = req.user?.id || 'anonymous';
        const { aiType, title } = req.body;
        const id = await conversationService.createConversation(userId, aiType, title);
        res.json({ id });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// 新增 API: 获取对话消息
app.get('/api/conversations/:id/messages', async (req, res) => {
    try {
        const messages = await conversationService.getMessages(req.params.id);
        res.json(messages);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// 修改聊天接口，保存消息到数据库
// 在 _finalizeAIMessage 后添加保存逻辑
```

---

## 7. 部署配置

### 7.1 SAP BTP 环境变量

在 BTP Cockpit 中添加数据库环境变量：

```
DB_HOST=rm-xxxxx.mysql.rds.aliyuncs.com
DB_PORT=3306
DB_NAME=ai_chat_db
DB_USER=ai_chat_user
DB_PASSWORD=<密码>
DB_SSL=true
```

### 7.2 网络配置

确保 SAP BTP 可以访问阿里云 RDS：

1. **RDS 白名单**: 添加 SAP BTP 的出口 IP
2. **或使用公网访问**: 开启 RDS 公网访问（需额外费用）
3. **或使用 VPN/专线**: 企业级方案

### 7.3 SSL 配置

下载阿里云 RDS SSL 证书并配置：

```javascript
const pool = mysql.createPool({
    // ...
    ssl: {
        ca: fs.readFileSync('/path/to/ca-cert.pem'),
        rejectUnauthorized: true
    }
});
```

---

## 8. 数据迁移

### 8.1 从 localStorage 迁移

前端添加迁移逻辑：

```javascript
async function migrateLocalData() {
    const localData = localStorage.getItem('ai_chat_conversations');
    if (!localData) return;
    
    const conversations = JSON.parse(localData);
    
    for (const conv of conversations) {
        // 调用 API 创建对话
        const response = await fetch('/api/conversations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                aiType: conv.aiType,
                title: conv.title
            })
        });
        const { id } = await response.json();
        
        // 保存消息
        for (const msg of conv.messages) {
            await fetch(`/api/conversations/${id}/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    role: msg.role,
                    content: msg.content
                })
            });
        }
    }
    
    // 迁移完成后删除本地数据
    localStorage.removeItem('ai_chat_conversations');
    console.log('数据迁移完成');
}
```

### 8.2 备份策略

配置 RDS 自动备份：

| 配置项 | 推荐值 |
|-------|-------|
| 备份周期 | 每日 |
| 备份时间 | 凌晨 2:00-3:00 |
| 日志备份 | 开启 |
| 保留天数 | 7 天 |

---

## 📋 实施清单

| 步骤 | 任务 | 状态 |
|-----|------|------|
| 1 | 创建阿里云 RDS 实例 | ⬜ |
| 2 | 配置数据库账号和白名单 | ⬜ |
| 3 | 执行表结构创建脚本 | ⬜ |
| 4 | 添加后端数据库依赖 | ⬜ |
| 5 | 实现对话存储服务 | ⬜ |
| 6 | 修改 API 集成数据库 | ⬜ |
| 7 | 前端对接新 API | ⬜ |
| 8 | 数据迁移测试 | ⬜ |
| 9 | 部署到 BTP | ⬜ |
| 10 | 生产环境验证 | ⬜ |

---

*最后更新: 2025-01-08*
