# 问题与待办

> **更新日期**: 2025-01-08  
> **版本**: v1.4.3

---

## 📋 目录

1. [已知问题](#1-已知问题)
2. [待办事项](#2-待办事项)
3. [功能增强建议](#3-功能增强建议)
4. [技术债务](#4-技术债务)
5. [版本更新计划](#5-版本更新计划)

---

## 1. 已知问题

### 🔴 高优先级

#### 1.1 文件上传 403 权限错误 (NoPermission)

**描述**: 使用文件上传功能时，即使已加入业务空间，仍然报 403 权限错误。

**错误信息**:
```
Failed to load resource: the server responded with a status of 500 (Internal Server Error)
[FileUpload] 上传错误: Error: 申请上传租约失败: NoPermission: code: 403, 
You are not authorized to perform this action. request id: xxxxxxxx
```

**根本原因**: 阿里云 RAM 用户权限配置不完整。仅加入业务空间是不够的，还需要为 RAM 用户授予正确的权限策略。

**解决方案**:

1. **检查 RAM 用户权限**:
   - 登录 [阿里云 RAM 控制台](https://ram.console.aliyun.com/)
   - 找到创建 AccessKey 的 RAM 用户
   - 确保该用户拥有以下权限：

2. **需要的权限策略**:
   ```
   AliyunBailianFullAccess          # 百炼完整访问权限
   或者自定义策略包含以下 Action:
   - bailian:ApplyFileUploadLease   # 申请文件上传租约
   - bailian:AddFile                # 添加文件
   - bailian:DescribeFile           # 查询文件状态
   ```

3. **业务空间成员配置**:
   - 登录 [百炼控制台](https://bailian.console.aliyun.com/)
   - 进入业务空间 -> 空间管理 -> 成员管理
   - 确保 RAM 用户已添加为空间成员
   - 成员角色建议设置为 **管理员** 或 **开发者**

4. **验证配置**:
   - 确保 `.env` 中的 `BAILIAN_WORKSPACE_ID` 与业务空间 ID 一致
   - AccessKey 必须属于已授权的 RAM 用户

**常见错误排查**:

| 检查项 | 说明 |
|-------|------|
| RAM 权限不足 | 最常见原因，需添加 `AliyunBailianFullAccess` |
| 未加入业务空间 | RAM 用户必须是业务空间成员 |
| Workspace ID 错误 | 检查 `BAILIAN_WORKSPACE_ID` 是否正确 |
| AccessKey 不匹配 | 确保 AK/SK 属于已授权用户 |

**临时解决方案**: 暂时禁用文件上传功能，AI 对话功能不受影响。

---

#### 1.2 会话文件过期问题

**描述**: 会话文件（session file）在百炼平台上有有效期限制，过期后无法继续使用。

**影响**: 用户上传的文件可能在长时间对话后失效，导致 AI 无法继续访问文件内容。

**临时解决方案**: 提示用户重新上传文件。

**计划修复**: 
- [ ] 添加文件过期检测机制
- [ ] 提示用户文件即将过期
- [ ] 自动重新上传机制

---

#### 1.2 大文件解析超时

**描述**: 超过 30MB 的文件在解析时可能超时。

**影响**: 大型 PDF 或 Excel 文件上传后可能解析失败。

**临时解决方案**: 建议用户拆分大文件或提取关键内容。

**计划修复**:
- [ ] 增加解析超时时间（当前 120 秒）
- [ ] 添加后台异步解析支持
- [ ] 提供文件预处理建议

---

### 🟡 中优先级

#### 1.3 移动端键盘遮挡输入框

**描述**: 在某些移动设备上，软键盘弹出时可能遮挡输入框。

**影响**: iOS Safari 上尤为明显。

**临时解决方案**: 已添加 `safe-area-inset-bottom` 适配，但部分机型仍有问题。

**计划修复**:
- [ ] 优化移动端布局检测
- [ ] 添加键盘弹出事件监听
- [ ] 动态调整输入区域位置

---

#### 1.4 Mermaid 渲染兼容性

**描述**: 某些复杂的 Mermaid 语法可能渲染失败。

**影响**: AI 生成的流程图可能包含不兼容的语法。

**临时解决方案**: 使用"修复输出格式"功能自动修复常见问题。

**计划修复**:
- [ ] 增强 Mermaid 代码清理逻辑
- [ ] 添加更多语法验证规则
- [ ] 提供语法错误提示

---

### 🟢 低优先级

#### 1.5 代码复制按钮位置

**描述**: 在长代码块中，复制按钮可能被遮挡。

**影响**: 用户需要滚动才能看到复制按钮。

**计划修复**:
- [ ] 将复制按钮改为固定定位
- [ ] 添加浮动工具栏

---

#### 1.6 对话历史同步

**描述**: 对话历史仅存储在本地 localStorage，不同设备/浏览器间无法同步。

**影响**: 用户切换设备后看不到之前的对话。

**计划修复**:
- [ ] 添加云端同步功能（需后端支持）
- [ ] 提供导出/导入功能

---

## 2. 待办事项

### 📌 近期待办 (v1.5.0)

| 任务 | 优先级 | 状态 | 负责人 |
|-----|--------|------|--------|
| 添加对话导出功能 | 高 | ⏳ 计划中 | - |
| 优化流式响应性能 | 中 | ⏳ 计划中 | - |
| 添加消息搜索功能 | 中 | ⏳ 计划中 | - |
| 完善错误提示信息 | 中 | ⏳ 计划中 | - |
| 添加深色模式支持 | 低 | ⏳ 计划中 | - |

### 📌 中期待办 (v1.6.0)

| 任务 | 优先级 | 状态 | 说明 |
|-----|--------|------|------|
| 多模态支持（图片） | 高 | 🔍 调研中 | 百炼 API 支持情况 |
| 语音输入支持 | 中 | 🔍 调研中 | Web Speech API |
| 对话分享功能 | 中 | ⏳ 计划中 | 生成分享链接 |
| 自定义 AI 助手 | 低 | 🔍 调研中 | 用户自定义 prompt |

### 📌 长期待办 (v2.0.0)

| 任务 | 优先级 | 状态 | 说明 |
|-----|--------|------|------|
| 多用户协作 | 高 | 📝 待规划 | 共享对话、权限管理 |
| 对话模板 | 中 | 📝 待规划 | 预设对话场景 |
| API 开放 | 中 | 📝 待规划 | 第三方集成 |
| 插件系统 | 低 | 📝 待规划 | 扩展 AI 能力 |

---

## 3. 功能增强建议

### 💡 用户体验

1. **快捷键支持**
   - `Ctrl/Cmd + Enter`: 发送消息
   - `Ctrl/Cmd + N`: 新建对话
   - `Ctrl/Cmd + /`: 显示快捷键帮助

2. **消息操作增强**
   - 消息编辑（重新发送）
   - 消息收藏
   - 消息分支（fork 对话）

3. **界面优化**
   - 可调整侧边栏宽度
   - 消息字体大小设置
   - 代码主题切换

### 💡 AI 功能

1. **提示词模板**
   - 预设常用提示词
   - 用户自定义模板
   - 模板分享

2. **上下文管理**
   - 手动添加上下文
   - 上下文可视化
   - 上下文来源标注

3. **多模型支持**
   - 模型切换
   - 对比不同模型回答
   - 自动选择最优模型

### 💡 集成功能

1. **IDE 插件**
   - VS Code 插件
   - ABAP Development Tools 集成
   - SAP Business Application Studio 集成

2. **工作流集成**
   - 与 Jenkins 集成
   - 与 Git 集成（代码审查）
   - 与 Jira 集成（任务管理）

---

## 4. 技术债务

### ⚠️ 需要重构

#### 4.1 Main.controller.js 过大

**问题**: `Main.controller.js` 文件超过 1500 行，包含过多职责。

**建议**: 
- 拆分为多个 Controller 或 Helper 类
- 提取文件上传逻辑到独立模块
- 提取 Markdown 渲染逻辑

---

#### 4.2 CSS 组织优化

**问题**: `style.css` 文件结构可优化，部分样式可复用。

**建议**:
- 使用 CSS 变量统一颜色、间距
- 拆分为多个 CSS 文件
- 考虑使用 CSS 预处理器

---

#### 4.3 错误处理标准化

**问题**: 不同接口错误处理方式不一致。

**建议**:
- 定义统一的错误响应格式
- 添加错误代码枚举
- 前端统一错误处理逻辑

---

### 🔧 代码质量

| 任务 | 优先级 | 说明 |
|-----|--------|------|
| 添加单元测试 | 高 | 后端 API 测试、前端组件测试 |
| 添加 E2E 测试 | 中 | 使用 Selenium 或 Playwright |
| 代码注释完善 | 中 | JSDoc 规范注释 |
| 类型定义 | 低 | 考虑迁移到 TypeScript |

---

## 5. 版本更新计划

### v1.4.4 (计划: 2025-01)

- [ ] 修复移动端键盘遮挡问题
- [ ] 优化 Mermaid 代码清理逻辑
- [ ] 添加文件上传进度显示优化

### v1.5.0 (计划: 2025-02)

- [ ] 对话导出功能（Markdown/PDF）
- [ ] 消息搜索功能
- [ ] 深色模式支持
- [ ] 性能优化

### v1.6.0 (计划: 2025-Q2)

- [ ] 多模态支持（图片输入）
- [ ] 语音输入支持
- [ ] 对话分享功能

### v2.0.0 (计划: 2025-Q3+)

- [ ] 多用户协作功能
- [ ] 插件系统架构
- [ ] API 开放平台

---

## 6. 贡献指南

### 报告问题

发现问题时，请提供以下信息：

1. **问题描述**: 简明扼要描述问题
2. **复现步骤**: 详细的复现步骤
3. **期望行为**: 预期应该如何工作
4. **实际行为**: 实际发生了什么
5. **环境信息**: 浏览器、操作系统、版本号
6. **截图/日志**: 如有，请附上相关截图或日志

### 功能建议

提交功能建议时，请说明：

1. **需求背景**: 为什么需要这个功能
2. **目标用户**: 谁会使用这个功能
3. **使用场景**: 具体的使用场景描述
4. **预期效果**: 功能实现后的预期效果
5. **参考实现**: 如有类似功能的参考

---

## 📊 问题统计

| 类别 | 数量 |
|-----|------|
| 🔴 高优先级问题 | 3 |
| 🟡 中优先级问题 | 2 |
| 🟢 低优先级问题 | 2 |
| ⏳ 待办事项 | 15+ |
| 💡 功能建议 | 20+ |
| ⚠️ 技术债务 | 6 |

---

*最后更新: 2025-01-08*
