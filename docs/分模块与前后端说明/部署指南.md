# éƒ¨ç½²æŒ‡å—

> **ç›®æ ‡å¹³å°**: SAP Business Technology Platform (BTP) / Cloud Foundry  
> **æ„å»ºå·¥å…·**: MTA Build Tool (mbt)  
> **å‰ç«¯æ„å»º**: @ui5/cli

---

## ğŸ“‹ ç›®å½•

1. [ç¯å¢ƒå‡†å¤‡](#1-ç¯å¢ƒå‡†å¤‡)
2. [æœ¬åœ°å¼€å‘](#2-æœ¬åœ°å¼€å‘)
3. [æ„å»º MTA åŒ…](#3-æ„å»º-mta-åŒ…)
4. [éƒ¨ç½²åˆ° SAP BTP](#4-éƒ¨ç½²åˆ°-sap-btp)
5. [é…ç½®æœåŠ¡](#5-é…ç½®æœåŠ¡)
6. [éªŒè¯éƒ¨ç½²](#6-éªŒè¯éƒ¨ç½²)
7. [æ›´æ–°ä¸å›æ»š](#7-æ›´æ–°ä¸å›æ»š)
8. [å¸è½½åº”ç”¨](#8-å¸è½½åº”ç”¨)
9. [å¸¸è§é—®é¢˜](#9-å¸¸è§é—®é¢˜)

---

## 1. ç¯å¢ƒå‡†å¤‡

### 1.1 æœ¬åœ°å¼€å‘ç¯å¢ƒ

| å·¥å…· | ç‰ˆæœ¬è¦æ±‚ | å®‰è£…å‘½ä»¤ |
|-----|---------|---------|
| Node.js | >= 18.0.0 | [ä¸‹è½½å®‰è£…](https://nodejs.org/) |
| npm | >= 8.0.0 | éš Node.js å®‰è£… |
| Cloud Foundry CLI | æœ€æ–°ç‰ˆ | [å®‰è£…æŒ‡å—](https://docs.cloudfoundry.org/cf-cli/install-go-cli.html) |
| MTA Build Tool | >= 1.2.29 | `npm install -g mbt` |

### 1.2 éªŒè¯å®‰è£…

```bash
# éªŒè¯ Node.js
node --version
# è¾“å‡º: v18.x.x æˆ–æ›´é«˜

# éªŒè¯ npm
npm --version
# è¾“å‡º: 8.x.x æˆ–æ›´é«˜

# éªŒè¯ CF CLI
cf --version
# è¾“å‡º: cf version 8.x.x

# éªŒè¯ MBT
mbt --version
# è¾“å‡º: v1.2.x
```

### 1.3 SAP BTP è´¦æˆ·å‡†å¤‡

ç¡®ä¿æ‚¨æœ‰ä»¥ä¸‹æƒé™ï¼š

- [x] Cloud Foundry ç©ºé—´çš„å¼€å‘è€…æƒé™
- [x] åˆ›å»ºæœåŠ¡å®ä¾‹çš„æƒé™
- [x] HTML5 åº”ç”¨ä»“åº“è®¿é—®æƒé™
- [x] Destination æœåŠ¡è®¿é—®æƒé™

---

## 2. æœ¬åœ°å¼€å‘

### 2.1 å…‹éš†/è·å–é¡¹ç›®

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd abap-clean-core-ai-fiori-new-standard-v1.4.3
```

### 2.2 å®‰è£…ä¾èµ–

```bash
# å®‰è£…æ‰€æœ‰ä¾èµ–
npm install
```

### 2.3 é…ç½®ç¯å¢ƒå˜é‡

```bash
# æ–°å»º .env æ–‡ä»¶ï¼ˆå‚è€ƒä¸‹æ–‡ç¤ºä¾‹ï¼‰
# Windows: type nul > .env
# macOS/Linux: touch .env

# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å†™ API å¯†é’¥
# ä½¿ç”¨ä½ å–œæ¬¢çš„ç¼–è¾‘å™¨
notepad .env   # Windows
code .env      # VS Code
```

**å¿…éœ€çš„ç¯å¢ƒå˜é‡**ï¼š

```bash
# DashScope API é…ç½®
DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxxxxx
DASHSCOPE_APP_ID=xxxxxxxx
DASHSCOPE_APP_ID_ABAP=xxxxxxxx
# ... å…¶ä»– AI åŠ©æ‰‹ ID

# æ–‡ä»¶ä¸Šä¼ é…ç½®ï¼ˆå¯é€‰ï¼‰
BAILIAN_ACCESS_KEY_ID=LTAI5txxxxxxxxxx
BAILIAN_ACCESS_KEY_SECRET=xxxxxxxxxx
BAILIAN_WORKSPACE_ID=llm-njsp72bv281ofywg
```

### 2.4 å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼‰
npm run dev
```

**å¯åŠ¨è¾“å‡ºç¤ºä¾‹**ï¼š

```
[cds] - æœåŠ¡å™¨å·²å¯åŠ¨: http://localhost:4004
[cds] - è®¿é—®åº”ç”¨: http://localhost:4004/ai-chat-gui/webapp/index.html
[AI] å·²é…ç½®çš„åŠ©æ‰‹:
  - abap-clean-core: abc12345...
```

### 2.5 å¼€å‘æ¨¡å¼ URL å‚æ•°

| å‚æ•° | æè¿° |
|-----|------|
| `?sap-ui-debug=true` | å¯ç”¨ UI5 è°ƒè¯•æ¨¡å¼ |
| `?sap-ui-xx-viewCache=false` | ç¦ç”¨è§†å›¾ç¼“å­˜ï¼ˆå·²é»˜è®¤æ·»åŠ ï¼‰ |
| `?sap-language=zh_CN` | åˆ‡æ¢åˆ°ä¸­æ–‡ç•Œé¢ |

### 2.6 å¯ç”¨çš„ npm è„šæœ¬

| å‘½ä»¤ | æè¿° |
|-----|------|
| `npm run dev` | å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼Œè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ |
| `npm run start` | ç”Ÿäº§æ¨¡å¼å¯åŠ¨ |
| `npm run build` | æ„å»º MTA åŒ… |
| `npm run deploy` | éƒ¨ç½²åˆ° Cloud Foundry |
| `npm run undeploy` | ä» Cloud Foundry å¸è½½ |

---

## 3. æ„å»º MTA åŒ…

### 3.1 æ„å»ºå‘½ä»¤

```bash
# æ¸…ç†æ—§æ„å»ºå¹¶æ„å»º MTA åŒ…
npm run build
```

**ç­‰æ•ˆå‘½ä»¤**ï¼š
```bash
rimraf resources mta_archives && mbt build --mtar archive
```

### 3.2 æ„å»ºè¿‡ç¨‹

æ„å»ºè¿‡ç¨‹åŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š

1. **æ¸…ç†æ—§æ–‡ä»¶**: åˆ é™¤ `resources/` å’Œ `mta_archives/` ç›®å½•
2. **å®‰è£…å‰ç«¯ä¾èµ–**: `npm install`ï¼ˆåœ¨ `app/ai-chat-gui/` ä¸‹ï¼‰
3. **æ„å»ºå‰ç«¯**: `npm run build:cf`
4. **CDS æ„å»º**: `npx cds build --production`
5. **æ‰“åŒ… MTA**: ç”Ÿæˆ `mta_archives/archive.mtar`

### 3.3 æ„å»ºè¾“å‡º

```
mta_archives/
â””â”€â”€ archive.mtar    # MTA å½’æ¡£æ–‡ä»¶ï¼ˆç”¨äºéƒ¨ç½²ï¼‰

gen/
â”œâ”€â”€ srv/           # åç«¯æœåŠ¡æ„å»ºäº§ç‰©
â””â”€â”€ app/           # å‰ç«¯æ„å»ºäº§ç‰©
```

### 3.4 æ„å»ºæ—¥å¿—ç¤ºä¾‹

```
[INFO] Reading MTA descriptor: mta.yaml
[INFO] Building modules: abap-clean-core-ai-fiori-new-srv, ...
[INFO] Building module: comaiassistantaichatapp
[INFO] Running custom build for module: comaiassistantaichatapp
> npm install
> npm run build:cf
[INFO] Pack module: comaiassistantaichatapp
[INFO] Building module: abap-clean-core-ai-fiori-new-srv
[INFO] Building CDS services
[INFO] Module build completed
[INFO] Creating MTA archive: mta_archives/archive.mtar
[INFO] Build successful
```

---

## 4. éƒ¨ç½²åˆ° SAP BTP

### 4.1 ç™»å½• Cloud Foundry

```bash
# ç™»å½• CFï¼ˆä½¿ç”¨æ‚¨çš„ API ç«¯ç‚¹ï¼‰
cf login -a https://api.cf.cn40.hana.ondemand.com

# æˆ–ä½¿ç”¨ SSO ç™»å½•
cf login -a https://api.cf.cn40.hana.ondemand.com --sso
```

**è¾“å…¥å‡­æ®**ï¼š
```
Email: your.email@company.com
Password: ********
```

### 4.2 é€‰æ‹©ç»„ç»‡å’Œç©ºé—´

```bash
# æŸ¥çœ‹å¯ç”¨çš„ç»„ç»‡
cf orgs

# é€‰æ‹©ç»„ç»‡
cf target -o <your-org>

# æŸ¥çœ‹å¯ç”¨çš„ç©ºé—´
cf spaces

# é€‰æ‹©ç©ºé—´
cf target -s <your-space>
```

### 4.3 éƒ¨ç½²åº”ç”¨

```bash
# éƒ¨ç½² MTA åŒ…
npm run deploy
```

**ç­‰æ•ˆå‘½ä»¤**ï¼š
```bash
cf deploy mta_archives/archive.mtar --retries 1
```

### 4.4 éƒ¨ç½²è¿‡ç¨‹

éƒ¨ç½²å°†è‡ªåŠ¨ï¼š

1. åˆ›å»º/æ›´æ–°æœåŠ¡å®ä¾‹ï¼š
   - `abap-clean-core-ai-fiori-new-auth` (XSUAA)
   - `abap-clean-core-ai-fiori-new-destination` (Destination)
   - `abap-clean-core-ai-fiori-new-html5-repo-host` (HTML5 Repository)

2. éƒ¨ç½²æ¨¡å—ï¼š
   - `abap-clean-core-ai-fiori-new-srv` (Node.js åç«¯)
   - `comaiassistantaichatapp` (HTML5 å‰ç«¯)

3. é…ç½®è·¯ç”±å’Œç»‘å®š

### 4.5 éƒ¨ç½²æ—¥å¿—ç¤ºä¾‹

```
Deploying multi-target app archive mta_archives/archive.mtar...
Uploading 1 files... OK
Creating service "abap-clean-core-ai-fiori-new-auth"... OK
Creating service "abap-clean-core-ai-fiori-new-html5-repo-host"... OK
Creating service "abap-clean-core-ai-fiori-new-destination"... OK
Uploading application "abap-clean-core-ai-fiori-new-srv"... OK
Starting application "abap-clean-core-ai-fiori-new-srv"... OK
Uploading content to HTML5 repository... OK
Configuring destination content... OK
Process finished successfully.
```

---

## 5. é…ç½®æœåŠ¡

### 5.1 é…ç½®ç¯å¢ƒå˜é‡

éƒ¨ç½²åï¼Œéœ€è¦åœ¨ BTP Cockpit ä¸­ä¸ºåç«¯æœåŠ¡é…ç½®ç¯å¢ƒå˜é‡ï¼š

1. æ‰“å¼€ **BTP Cockpit** > **Cloud Foundry** > **Spaces** > æ‚¨çš„ç©ºé—´
2. ç‚¹å‡» `abap-clean-core-ai-fiori-new-srv` åº”ç”¨
3. è¿›å…¥ **ç¯å¢ƒå˜é‡/Environment Variables**
4. æ·»åŠ ä»¥ä¸‹ç”¨æˆ·å®šä¹‰å˜é‡ï¼š

```
DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxxxxx
DASHSCOPE_APP_ID=xxxxxxxx
DASHSCOPE_APP_ID_ABAP=xxxxxxxx
DASHSCOPE_APP_ID_CPI=xxxxxxxx
DASHSCOPE_APP_ID_FUNC_DOC=xxxxxxxx
DASHSCOPE_APP_ID_TECH_DOC=xxxxxxxx
DASHSCOPE_APP_ID_CODE_REVIEW=xxxxxxxx
DASHSCOPE_APP_ID_UNIT_TEST=xxxxxxxx
DASHSCOPE_APP_ID_DIAGRAM=xxxxxxxx
BAILIAN_ACCESS_KEY_ID=LTAI5txxxxxxxxxx
BAILIAN_ACCESS_KEY_SECRET=xxxxxxxxxx
BAILIAN_WORKSPACE_ID=llm-njsp72bv281ofywg
```

5. ç‚¹å‡» **Save**
6. **é‡å¯åº”ç”¨**ï¼šåœ¨åº”ç”¨æ¦‚è§ˆé¡µé¢ç‚¹å‡» **Restart**

### 5.2 é…ç½®ç”¨æˆ·è§’è‰²

1. æ‰“å¼€ **BTP Cockpit** > **Security** > **Role Collections**
2. æ‰¾åˆ° `AIChat_User` è§’è‰²é›†åˆ
3. ç‚¹å‡»è¿›å…¥ï¼Œæ·»åŠ éœ€è¦è®¿é—®åº”ç”¨çš„ç”¨æˆ·
4. ä¿å­˜æ›´æ”¹

### 5.3 Destination é…ç½®ï¼ˆå¦‚éœ€ï¼‰

å¦‚æœéœ€è¦é…ç½®é¢å¤–çš„ Destinationï¼š

1. æ‰“å¼€ **BTP Cockpit** > **Connectivity** > **Destinations**
2. ç‚¹å‡» **New Destination**
3. é…ç½®å¦‚ä¸‹ï¼š

| å±æ€§ | å€¼ |
|-----|-----|
| Name | `dashscope-api` |
| Type | HTTP |
| URL | `https://dashscope.aliyuncs.com` |
| Authentication | NoAuthentication |
| ProxyType | Internet |

---

## 6. éªŒè¯éƒ¨ç½²

### 6.1 æ£€æŸ¥åº”ç”¨çŠ¶æ€

```bash
# æŸ¥çœ‹åº”ç”¨çŠ¶æ€
cf apps

# è¾“å‡ºç¤ºä¾‹
name                                   state    instances
abap-clean-core-ai-fiori-new-srv      started  1/1
```

### 6.2 æŸ¥çœ‹åº”ç”¨æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
cf logs abap-clean-core-ai-fiori-new-srv

# æŸ¥çœ‹æœ€è¿‘æ—¥å¿—
cf logs abap-clean-core-ai-fiori-new-srv --recent
```

### 6.3 è®¿é—®åº”ç”¨

åº”ç”¨è®¿é—®åœ°å€å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ°ï¼š

1. **BTP Cockpit** > **HTML5 Applications** > æ‰¾åˆ°åº”ç”¨
2. æˆ–é€šè¿‡ **SAP Build Work Zone** è®¿é—®

URL æ ¼å¼ç±»ä¼¼ï¼š
```
https://<subdomain>.launchpad.cfapps.cn40.hana.ondemand.com/site#AIChat-Display
```

### 6.4 åŠŸèƒ½æµ‹è¯•

- [x] é¦–é¡µåŠ è½½æ­£å¸¸
- [x] AI åŠ©æ‰‹ç£è´´å¯ç‚¹å‡»
- [x] èŠå¤©åŠŸèƒ½æ­£å¸¸
- [x] æµå¼å“åº”æ­£å¸¸
- [x] æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æ­£å¸¸ï¼ˆå¦‚å·²é…ç½®ï¼‰
- [x] æµç¨‹å›¾ç”Ÿæˆæ­£å¸¸

---

## 7. æ›´æ–°ä¸å›æ»š

### 7.1 æ›´æ–°åº”ç”¨

```bash
# 1. ä¿®æ”¹ä»£ç åé‡æ–°æ„å»º
npm run build

# 2. é‡æ–°éƒ¨ç½²
npm run deploy
```

### 7.2 è“ç»¿éƒ¨ç½²

MTA éƒ¨ç½²é»˜è®¤æ”¯æŒæ»šåŠ¨æ›´æ–°ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

### 7.3 å›æ»š

å¦‚éœ€å›æ»šåˆ°ä¹‹å‰ç‰ˆæœ¬ï¼š

1. è·å–ä¹‹å‰çš„ `archive.mtar` æ–‡ä»¶
2. æ‰§è¡Œéƒ¨ç½²å‘½ä»¤

```bash
cf deploy <path-to-old-archive.mtar> --retries 1
```

---

## 8. å¸è½½åº”ç”¨

### 8.1 å®Œå…¨å¸è½½

```bash
# å¸è½½åº”ç”¨åŠæ‰€æœ‰ç›¸å…³æœåŠ¡
npm run undeploy
```

**ç­‰æ•ˆå‘½ä»¤**ï¼š
```bash
cf undeploy abap-clean-core-ai-fiori-new --delete-services --delete-service-keys --delete-service-brokers
```

### 8.2 å¸è½½ç¡®è®¤

```
Do you really want to undeploy application "abap-clean-core-ai-fiori-new"? [y/n]: y
Undeploying application...
Deleting application "abap-clean-core-ai-fiori-new-srv"... OK
Deleting service "abap-clean-core-ai-fiori-new-auth"... OK
Deleting service "abap-clean-core-ai-fiori-new-html5-repo-host"... OK
Deleting service "abap-clean-core-ai-fiori-new-destination"... OK
Process finished successfully.
```

---

## 9. å¸¸è§é—®é¢˜

### Q1: æ„å»ºå¤±è´¥ - npm install é”™è¯¯

**é—®é¢˜**: å‰ç«¯æ„å»ºæ—¶ `npm install` å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ¸…ç† node_modules å¹¶é‡æ–°å®‰è£…
cd app/ai-chat-gui
rm -rf node_modules package-lock.json
npm install
cd ../..
npm run build
```

### Q2: éƒ¨ç½²å¤±è´¥ - æœåŠ¡åˆ›å»ºé”™è¯¯

**é—®é¢˜**: æœåŠ¡å®ä¾‹åˆ›å»ºå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥é…é¢ï¼šç¡®ä¿æœ‰è¶³å¤Ÿçš„æœåŠ¡é…é¢
2. æ£€æŸ¥æƒé™ï¼šç¡®ä¿æœ‰åˆ›å»ºæœåŠ¡çš„æƒé™
3. æ‰‹åŠ¨åˆ é™¤æ®‹ç•™æœåŠ¡ï¼š
```bash
cf delete-service <service-name> -f
```

### Q3: åº”ç”¨å¯åŠ¨å¤±è´¥ - ç«¯å£ç»‘å®šé”™è¯¯

**é—®é¢˜**: åº”ç”¨å¯åŠ¨æ—¶ç«¯å£ç»‘å®šå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
- Cloud Foundry ä¼šè‡ªåŠ¨åˆ†é…ç«¯å£ï¼Œç¡®ä¿ä»£ç ä½¿ç”¨ `process.env.PORT`
- æ£€æŸ¥ `package.json` ä¸­çš„å¯åŠ¨å‘½ä»¤

### Q4: AI åŠŸèƒ½ä¸å¯ç”¨

**é—®é¢˜**: éƒ¨ç½²å AI åŠŸèƒ½è¿”å›é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®é…ç½®
2. ç¡®ä¿å·²é‡å¯åº”ç”¨
3. æŸ¥çœ‹åº”ç”¨æ—¥å¿—ç¡®è®¤ API å¯†é’¥åŠ è½½

```bash
cf logs abap-clean-core-ai-fiori-new-srv --recent | grep "\[AI\]"
```

### Q5: æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ä¸å¯ç”¨

**é—®é¢˜**: æ–‡ä»¶ä¸Šä¼ è¿”å› `CONFIG_ERROR`

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®ä¿é…ç½®äº† `BAILIAN_ACCESS_KEY_ID` å’Œ `BAILIAN_ACCESS_KEY_SECRET`
2. ç¡®ä¿ AccessKey æœ‰ç™¾ç‚¼ç›¸å…³æƒé™
3. ç¡®ä¿ `BAILIAN_WORKSPACE_ID` æ­£ç¡®

### Q6: ç”¨æˆ·æ— æ³•è®¿é—®åº”ç”¨

**é—®é¢˜**: ç”¨æˆ·è®¿é—®åº”ç”¨æ—¶æç¤ºæœªæˆæƒ

**è§£å†³æ–¹æ¡ˆ**:
1. åœ¨ BTP Cockpit ä¸­ä¸ºç”¨æˆ·åˆ†é… `AIChat_User` è§’è‰²é›†åˆ
2. ç­‰å¾…å‡ åˆ†é’Ÿè®©æƒé™ç”Ÿæ•ˆ
3. è®©ç”¨æˆ·åˆ·æ–°é¡µé¢æˆ–é‡æ–°ç™»å½•

### Q7: æœ¬åœ°å¼€å‘ç«¯å£è¢«å ç”¨

**é—®é¢˜**: å¯åŠ¨æ—¶æç¤ºç«¯å£å·²è¢«å ç”¨

**è§£å†³æ–¹æ¡ˆ**:
- åº”ç”¨ä¼šè‡ªåŠ¨å°è¯•ä¸‹ä¸€ä¸ªå¯ç”¨ç«¯å£ï¼ˆ4005, 4006...ï¼‰
- æˆ–æ‰‹åŠ¨æŒ‡å®šç«¯å£ï¼š
```bash
PORT=5000 npm run dev
```

---

## ğŸ“š å‚è€ƒé“¾æ¥

- [SAP CAP å®˜æ–¹æ–‡æ¡£](https://cap.cloud.sap/docs/)
- [SAP UI5 æ–‡æ¡£](https://ui5.sap.com/)
- [Cloud Foundry CLI å‚è€ƒ](https://docs.cloudfoundry.org/cf-cli/)
- [MTA Build Tool æ–‡æ¡£](https://help.sap.com/docs/SAP_HANA_PLATFORM/4505d0bdaf4948449b7f7379d24d0f0d/8d1b3f9f7f4e4a258bcc0e3621b5f5fb.html)
- [é˜¿é‡Œäº‘ç™¾ç‚¼æ–‡æ¡£](https://help.aliyun.com/product/93837.html)
