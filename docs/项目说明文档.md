# ABAP Clean Core AI Helper - 项目说明文档

## 项目概述

这是一个基于 SAP UI5 + Node.js/CAP 的 AI 智能助手平台，集成阿里云百炼（DashScope）大模型服务，提供多种 AI 助手功能，帮助开发者提升 ABAP 开发效率。

## 核心功能

### 1. AI 聊天助手
- **ABAP Clean Core 助手**：帮助将传统 ABAP 代码重构为云就绪代码
- **CPI 集成助手**：SAP CPI 集成开发指导
- **功能文档助手**：自动生成功能文档
- **技术文档助手**：自动生成技术设计文档
- **代码审查助手**：智能代码质量检查
- **单元测试助手**：自动生成 ABAP 单元测试代码

### 2. Diagram Helper（流程图助手）
- 用户用自然语言描述流程图需求
- 调用 AI 智能体生成 Mermaid 代码
- 前端实时渲染可交互流程图
- 支持缩放、拖拽、重置视图
- 支持下载 PNG/SVG、复制图片
- 集成 Draw.io 编辑器进行进一步编辑和导出

## 技术架构

### 前端技术栈
- **SAP UI5**：企业级前端框架
- **Mermaid.js**：流程图渲染引擎（CDN 加载）
- **marked.js**：Markdown 渲染
- **highlight.js**：代码高亮
- **Draw.io (embed.diagrams.net)**：嵌入式图表编辑器

### 后端技术栈
- **Node.js**：运行时环境
- **SAP CAP (Cloud Application Programming)**：后端框架
- **Express.js**：HTTP 服务器
- **阿里云百炼 DashScope API**：AI 大模型服务

### AI 服务
- **模型**：通义千问（qwen-max / qwen3-max）
- **调用方式**：流式响应（SSE）
- **智能体应用**：通过 DashScope Application API 调用预配置的智能体

## 项目目录结构

```
├── app/                          # 前端应用
│   ├── ai-chat-gui/              # UI5 应用主目录
│   │   ├── webapp/
│   │   │   ├── controller/       # 控制器
│   │   │   │   ├── App.controller.js
│   │   │   │   ├── Home.controller.js      # 首页控制器
│   │   │   │   ├── Main.controller.js      # 聊天页控制器
│   │   │   │   └── Diagram.controller.js   # 流程图页控制器
│   │   │   ├── view/             # 视图
│   │   │   │   ├── App.view.xml
│   │   │   │   ├── Home.view.xml           # 首页（Launchpad）
│   │   │   │   ├── Main.view.xml           # 聊天页
│   │   │   │   ├── Diagram.view.xml        # 流程图页
│   │   │   │   └── DrawioDialog.fragment.xml # Draw.io 对话框
│   │   │   ├── css/
│   │   │   │   └── style.css     # 全局样式
│   │   │   ├── i18n/             # 国际化
│   │   │   │   ├── i18n.properties         # 默认语言
│   │   │   │   ├── i18n_en.properties      # 英文
│   │   │   │   └── i18n_zh_CN.properties   # 简体中文
│   │   │   ├── images/           # 图片资源
│   │   │   ├── Component.js      # UI5 组件入口
│   │   │   ├── manifest.json     # 应用配置
│   │   │   └── index.html        # 入口页面
│   │   ├── xs-app.json           # 路由配置
│   │   └── package.json
│   └── services.cds              # CDS 服务定义
│
├── srv/                          # 后端服务
│   ├── chat-service.cds          # 聊天服务 CDS 定义
│   ├── chat-service.js           # 聊天服务实现
│   └── server.js                 # 自定义服务器（AI API 代理）
│
├── db/                           # 数据库层
│   ├── schema.cds                # 数据模型定义
│   └── src/
│       └── .hdiconfig
│
├── .env                          # 环境变量（敏感信息，不提交）
├── .env.example                  # 环境变量示例
├── mta.yaml                      # MTA 部署配置
├── package.json                  # 项目依赖
└── xs-security.json              # 安全配置
```

## 环境配置

### 环境变量 (.env)
```properties
# 阿里云百炼 API 密钥
DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxxxxx

# 各 AI 助手的智能体应用 ID
DASHSCOPE_APP_ID_ABAP=xxxxxxxx          # ABAP Clean Core
DASHSCOPE_APP_ID_CPI=xxxxxxxx           # CPI 集成
DASHSCOPE_APP_ID_FUNC_DOC=xxxxxxxx      # 功能文档
DASHSCOPE_APP_ID_TECH_DOC=xxxxxxxx      # 技术文档
DASHSCOPE_APP_ID_CODE_REVIEW=xxxxxxxx   # 代码审查
DASHSCOPE_APP_ID_UNIT_TEST=xxxxxxxx     # 单元测试
DASHSCOPE_APP_ID_DIAGRAM=xxxxxxxx       # 流程图生成
```

## 运行方式

### 本地开发
```bash
# 安装依赖
npm install

# 启动开发服务器
npm run start
# 或
cds watch
```

### 访问地址
- 本地开发：http://localhost:4004/ai-chat-gui/webapp/index.html

## 核心功能实现说明

### AI 聊天功能
1. 前端通过 `fetch` 调用后端 `/api/chat` 接口
2. 后端 `server.js` 接收请求，根据 `aiType` 选择对应的智能体应用 ID
3. 调用阿里云百炼 DashScope Application API（流式响应）
4. 通过 SSE（Server-Sent Events）将 AI 响应实时推送到前端
5. 前端使用 `marked.js` 渲染 Markdown，`highlight.js` 高亮代码

### Diagram Helper 功能
1. 用户输入流程图描述，点击"生成"
2. 调用 AI 智能体，要求输出 Mermaid 代码块
3. 前端提取 Mermaid 代码，使用 `mermaid.render()` 渲染 SVG
4. 支持缩放（直接修改 SVG 宽高）、拖拽（容器滚动）
5. 下载功能：PNG 通过 Canvas 转换，SVG 直接导出
6. Draw.io 集成：嵌入 `embed.diagrams.net`，用户手动导入 Mermaid 代码

### Draw.io 集成说明
- 使用 `embed.diagrams.net` 嵌入模式（`app.diagrams.net` 有 CSP 限制）
- 参数配置：`ui=kennedy`（经典亮色主题）、`libraries=1`（启用形状库）
- Mermaid 导入方式：Arrange → Insert → Advanced → Mermaid
- 布局调整：Arrange → Layout（推荐 Vertical Flow）
- 线条样式：Edit → Select Edges → Style → Line

## 部署说明

### BTP Cloud Foundry 部署
```bash
# 构建 MTA 包
mbt build

# 部署到 BTP
cf deploy mta_archives/xxx.mtar
```

## 版本信息
- 版本：1.0.0
- 最后更新：2026-01-06
- GitHub：https://github.com/yzf121/product
