# 新环境部署指南

本指南面向将 CAP (Node.js) 后端 + UI5 前端部署到 BTP cn40，并通过 Work Zone 访问的场景，后端仅使用 apps.internal 内部路由，不依赖公网 route。

## 1) 前置条件
- Node.js 18+
- Cloud Foundry CLI + MultiApps Plugin (cf deploy)
- MBT (已通过根目录 `npm run build` 间接使用)

## 2) 设定目标空间
- 登录并指向目标 Subaccount / Space (cn40)：
  - `cf login` 并 `cf target -o <org> -s <space>`

## 3) 设置运行时环境变量
后端在运行时依赖以下环境变量 (建议在部署后设置并 restage)：

必填:
- `DASHSCOPE_API_KEY`
- `DASHSCOPE_APP_ID`

可选 (按功能启用):
- `DASHSCOPE_APP_ID_ABAP`
- `DASHSCOPE_APP_ID_CPI`
- `DASHSCOPE_APP_ID_FUNC_DOC`
- `DASHSCOPE_APP_ID_TECH_DOC`
- `DASHSCOPE_APP_ID_CODE_REVIEW`
- `DASHSCOPE_APP_ID_UNIT_TEST`
- `DASHSCOPE_APP_ID_DIAGRAM`

文件上传功能必填:
- `BAILIAN_ACCESS_KEY_ID`
- `BAILIAN_ACCESS_KEY_SECRET`

可选:
- `BAILIAN_WORKSPACE_ID` (未设置时默认 `llm-njsp72bv281ofywg`)

设置方式 (示例):
- `cf set-env abap-clean-core-ai-fiori-new-srv DASHSCOPE_API_KEY <value>`
- `cf set-env abap-clean-core-ai-fiori-new-srv DASHSCOPE_APP_ID <value>`
- `cf set-env abap-clean-core-ai-fiori-new-srv BAILIAN_ACCESS_KEY_ID <value>`
- `cf set-env abap-clean-core-ai-fiori-new-srv BAILIAN_ACCESS_KEY_SECRET <value>`
- `cf restage abap-clean-core-ai-fiori-new-srv`

## 4) 构建与部署
在项目根目录执行:
- `npm run build`
- `cf deploy mta_archives/archive.mtar`

## 5) Work Zone 内容发布
1. 进入 Work Zone Content Manager。
2. 在 HTML5 Apps 中找到应用 `com.ai.assistant.aichatapp` (service: `abap-clean-core-ai-fiori-new`)。
3. 将其添加到对应的 Content / Role，并发布到站点。

## 6) 角色分配
在 BTP Cockpit 给实际用户分配 Role Collection:
- `AIChat_User`

## 7) 验证清单
- Work Zone Content Manager 能看到应用，并可发布为 Tile。
- 从 Work Zone 打开 Tile 正常进入 UI。
- 在浏览器 Network 中确认前端请求为 `/api/...`，且无 401/403。

