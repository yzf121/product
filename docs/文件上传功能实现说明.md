# 文件上传功能实现说明

## 功能概述

本次实现了完整的"文件上传功能"，允许用户在聊天界面中上传文件作为对话上下文，让 AI 助手能够理解和处理文件内容。

## 实现的功能

### UI 界面
1. **上传按钮**：在输入框左侧添加了回形针图标的上传按钮
2. **附件预览区域**：选择文件后，在输入框上方显示文件卡片
3. **文件卡片样式**：
   - 显示文件类型图标（根据扩展名自动匹配）
   - 显示文件名
   - 显示上传/解析状态
   - 进度条（上传时显示进度，解析中显示动画）
   - 删除按钮（X 图标）

### 文件上传流程
1. 用户点击上传按钮，选择文件
2. 前端验证文件大小（最大 50MB）和类型
3. 文件上传到后端 `/api/files/session`
4. 后端执行百炼 OpenAPI 流程：
   - Step B1: 申请上传租约 (ApplyFileUploadLease)
   - Step B2: 上传文件到预签名 URL (OSS)
   - Step B3: 添加文件 (AddFile) 生成 file_session_xxx ID
   - Step B4: 轮询文件状态 (DescribeFile) 直到 FILE_IS_READY
5. 前端轮询文件状态，更新卡片显示

### 发送逻辑
- 点击发送时，自动获取所有已就绪的附件的 `fileId`
- 将 `sessionFileIds` 数组附加到请求体中
- 后端将 `session_file_ids` 注入到 DashScope Apps API 的 `rag_options` 中

## 技术实现

### 后端修改 (srv/server.js)

新增接口：
- `POST /api/files/session` - 上传文件并返回会话文件 ID
- `GET /api/files/session/:fileId/status` - 查询文件解析状态

修改接口：
- `POST /api/chat/stream` - 支持 `sessionFileIds` 参数

新增函数：
- `createBailianClient()` - 创建百炼 SDK 客户端
- `getBailianClient()` - 获取全局客户端实例
- `applyFileUploadLease()` - 申请上传租约
- `uploadToLeaseUrl()` - 上传到 OSS 预签名 URL
- `addSessionFile()` - 注册会话文件
- `describeFile()` - 查询文件状态
- `waitForFileReady()` - 轮询等待文件就绪

### 前端修改

**Main.view.xml:**
- 添加附件预览区域 `attachmentPreviewArea`
- 添加上传按钮 `uploadButton`
- 添加隐藏的文件输入 `hiddenFileInput`

**Main.controller.js:**
- 添加文件上传配置常量 `FILE_UPLOAD_CONFIG`
- 添加文件类型图标映射 `FILE_TYPE_ICONS`
- 添加初始化附件数组
- 添加文件上传相关函数：
  - `onUploadFile()` - 触发文件选择
  - `_handleFileSelect()` - 处理文件选择
  - `_uploadFile()` - 上传文件
  - `_pollFileStatus()` - 轮询状态
  - `_renderAttachmentCard()` - 渲染文件卡片
  - `_updateAttachmentCard()` - 更新卡片状态
  - `_removeAttachment()` - 删除附件
  - `_getReadySessionFileIds()` - 获取可用文件 ID
- 修改 `_buildRequestBody()` 添加 `sessionFileIds`

**style.css:**
- 添加附件预览区域样式
- 添加文件卡片/胶囊样式
- 添加进度条样式
- 添加删除按钮样式
- 添加响应式适配

### 依赖

新增 npm 依赖：
- `multer` - 处理 multipart/form-data 文件上传
- `form-data` - 发送表单数据
- `@alicloud/bailian20231229` - 阿里云百炼 SDK
- `@alicloud/openapi-client` - 阿里云 OpenAPI 客户端
- `@alicloud/tea-util` - 阿里云 SDK 工具库

### 环境变量

新增配置项（在 `.env` 文件中）：
```bash
# 阿里云 RAM AccessKey ID（在 server.js 中读取为 BAILIAN_AK）
BAILIAN_ACCESS_KEY_ID=LTAI5txxxxxxxxxx

# 阿里云 RAM AccessKey Secret（在 server.js 中读取为 BAILIAN_SK）
BAILIAN_ACCESS_KEY_SECRET=xxxxxxxxxx

# 百炼业务空间 ID（默认值：llm-njsp72bv281ofywg）
BAILIAN_WORKSPACE_ID=llm-njsp72bv281ofywg
```

**代码变量映射关系**:
```javascript
// 在 server.js 中：
const BAILIAN_AK = process.env.BAILIAN_ACCESS_KEY_ID;
const BAILIAN_SK = process.env.BAILIAN_ACCESS_KEY_SECRET;
const BAILIAN_WORKSPACE_ID = process.env.BAILIAN_WORKSPACE_ID || 'llm-njsp72bv281ofywg';
```

## 支持的文件类型

- PDF: `.pdf`
- Word: `.doc`, `.docx`
- Excel: `.xls`, `.xlsx`
- PowerPoint: `.ppt`, `.pptx`
- 文本: `.txt`, `.md`
- 数据: `.json`, `.xml`, `.csv`

## 配置限制

- 单文件最大: 50MB
- 单会话最多附件: 5 个
- 解析超时: 2 分钟

## 使用方法

1. 确保 `.env` 文件中配置了 `BAILIAN_ACCESS_KEY_ID` 和 `BAILIAN_ACCESS_KEY_SECRET`
2. 运行 `npm install` 安装新依赖
3. 启动应用 `npm run dev`
4. 在聊天界面点击回形针图标上传文件
5. 等待文件显示"已就绪"状态后发送消息

## 注意事项

1. **鉴权区分**:
   - 文件上传使用 RAM AK/SK
   - AI 对话使用 DashScope API Key
   
2. **安全要求**:
   - 所有密钥仅在后端 env 中读取
   - 禁止硬编码、打印日志、返回前端

3. **文件有效期**:
   - 会话文件是临时有效的
   - 过期后需要重新上传

4. **空间一致性**:
   - 文件与应用必须在同一业务空间 (Workspace) 下
